################################################################################
# 0000 Main
################################################################################
x0000_main   <- function(id, ...) {
# ------------------------------------------------------------------------------
    z0100_setup(id, ...)                %>%
      x0200_init(id, i, ...)            %>%
        x0300_ind(id, i, ...)           %>%
          x0400_signals(id, i, ...)     %>%
            x0500_rules(id, i, ...)     %>%
              x0600_limits(id, i, ...)
# ------------------------------------------------------------------------------
}
################################################################################
# 0100 Setup
################################################################################
z0100_setup   <- function(id, ...) {
# ------------------------------------------------------------------------------
    dt_key <<- id
    strategy.st <<- portfolio.st <<- account.st <<- dt_key[,2]   # strategy name
# ------------------------------------------------------------------------------
}
################################################################################
# 0200	Initialization
################################################################################
x0200_init    <- function(id, ...) {
# ------------------------------------------------------------------------------
  initPortf(name              = portfolio.st,         # Portfolio Initialization
            symbols           = symbols,
            currency          = curr,
            initDate          = initDate,
            initEq            = initEq)
# ------------------------------------------------------------------------------
  initAcct(name               = account.st,           # Account Initialization
           portfolios         = portfolio.st,
           currency           = curr,
           initDate           = initDate,
           initEq             = initEq)
# ------------------------------------------------------------------------------
  initOrders(portfolio        = unlist(portfolio.st), # Order Initialization
             symbols          = symbols,
             initDate         = initDate)
# ------------------------------------------------------------------------------
  strategy(unlist(strategy.st), store = TRUE)         # Strategy initialization
# ------------------------------------------------------------------------------
}
################################################################################
# 0300	Indicators
################################################################################
x0300_ind     <- function(id, ...) {
# ------------------------------------------------------------------------------
#   browser()
    print("x0300_ind")
# ------------------------------------------------------------------------------
    apply(g[[paste0("cross", dt_key[,3])]],
          1,                                                            # by row
          function(x)
            indicators(
              x[1],
              as.integer(x[2]),
              as.integer(x[3]),
              x[4])
         )
# ------------------------------------------------------------------------------
    paste0("str(", getStrategy(dt_key[,2]),"$indicators)")
# ------------------------------------------------------------------------------
    ApplyIndicators(dt_key[,2])            # apply indicators with strategy name
# ------------------------------------------------------------------------------
}
################################################################################
# 0400	Signals
################################################################################
x0400_signals <- function(id, ...) {
# ------------------------------------------------------------------------------
    print("x0400_signals")
# ------------------------------------------------------------------------------
#   print(dt_key)
#   print(class(dt_key))
# ------------------------------------------------------------------------------
#   print(id)
#   print(class(id))
# ------------------------------------------------------------------------------
#    browser()
  #> [1] "x0400_Signals"
# ------------------------------------------------------------------------------
  setkey(dt_key, position)
  apply(dT.entry, 1, function(x)
    AddSignals(
      sigFormula,
      paste("sig", tolower(dt_key[,3]),"col", sep = "_"),
      g[[paste(dt_key[,2], dT.trade[as.integer(x[1]),2], sep = "_")]],
      trigger,
      TRUE,
      dt_key[,2],
      paste0(dT.position[dt_key][, 2], x[2])
      )
    )
# ------------------------------------------------------------------------------
    paste0("str(", getStrategy(dt_key[,2]),"$signals)")
    ApplySignals(dt_key[,2])
# ------------------------------------------------------------------------------
}
################################################################################
# 0500	Rules
################################################################################
x0500_rules <- function(id, ...) {
# ------------------------------------------------------------------------------
    print("x0500_rules")
# ------------------------------------------------------------------------------
    print(dt_key)
    print(class(dt_key))
# ------------------------------------------------------------------------------
#   print(id)
#   print(class(id))
# ------------------------------------------------------------------------------
   browser()
  #> [1] "x0500_Rules"
# ------------------------------------------------------------------------------
rules(paste(dXema, "shortentry", sep = "_"), TRUE, orderqty, "long", "market", "Open", "market", 0, "enter")
rules(paste(dXema, "shortexit",  sep = "_"), TRUE,  "all",   "long", "market", "Open", "market", 0, "exit")
#  apply(dT.entry, 1, function(x)
#    rules(
# #      paste0(dt_key[,2], "_", dT.position[dt_key][, 2], x[2]),
#       paste(dXema, "shortentry", sep = "_"),
#       TRUE,
#       orderqty,
#       dT.position[dt_key][, 2],
#       market,
#       "Open",
#       market,
#       0,
#       "enter"
# #     x[2]
#    )
#  )
}
################################################################################
# 0600 Position Limits
################################################################################
x0600_limits <- function(id, ...) {
# ------------------------------------------------------------------------------
    print("x0600_limits")
# ------------------------------------------------------------------------------
    print(dt_key)
    print(class(dt_key))
# ------------------------------------------------------------------------------
#   print(id)
#   print(class(id))
# ------------------------------------------------------------------------------
    browser()
  #> [1] "x0600_Limits"
# ------------------------------------------------------------------------------
    positionLimits(maxpos, minpos)
}
################################################################################
# 0700	Strategy
################################################################################
x0600_limits <- function(id, ...) {
    Strategy(dt_key[,2])
}
