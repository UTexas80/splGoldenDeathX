---
title: "SPL Dashboard"
date: "`r params$reportdate`"
output:
  flexdashboard::flex_dashboard:
    orientation: row
    source_code: embed
    vertical_layout: fill
params:
  dateStart: "2002-01-02"
  dateEnd:  !r Sys.Date()
  dynamictitle: "My report"
  reportdate: !r Sys.Date()
  symbols: "SPL.AX"
  ticker: "SPL.AX"
runtime: shiny
theme: spacelab
---

```{r global, echo=FALSE, include=FALSE, message = FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
knitr::opts_knit$set(root.dir = "..", echo = FALSE)
library(d3heatmap)
library(data.table)
library(dplyr)
library(DT)
library(dygraphs)
library(flexdashboard)
library(formattable)
library(ggplot2)
library(gt)
library(here)
library(highcharter)
library(hydroTSM)
library(lubridate)
library(magrittr)
library(PerformanceAnalytics)
library(plotly)
library(quantmod)
library(readr)
library(rmarkdown)
library(scales)
library(shiny)
# library(shinybusy)
library(shinydashboard)
library(shinyWidgets)
# library(tidyquant)
library(stringr)
library(tidyverse)
library(timetk)
library(treemap)
library(utils)
library(xts)
library(zoo)
```

```{r functions}

# A function to build an xts object to hold both ticker returns.
# Function to calculate monthly returns on a stock
monthly_stock_returns <- function(ticker, dateStart) {

  # Download the data from Yahoo finance
  symbol <- getSymbols("SPL.AX",
    src = "yahoo", from = "2019-07-02",
    auto.assign = FALSE, warnings = FALSE
  )

  # Transform it to monthly returns using the periodReturn function from quantmod
  data <- periodReturn("SPL.AX", period = "monthly", type = "log")

  # Let's rename the column of returns to something intuitive because the column
  # name is what will eventually be displayed on the time series graph
  colnames(data) <- as.character("SPL.AX")

  # We want to be able to work with the xts objects that result from this function
  # so let's explicitly put them to the global environment with an easy to use
  # name, the stock ticker
  assign("SPL_returns", data, .GlobalEnv)
} # monthly_stock_returns


# xts_price <- tk_xts(price())
# xts_ma <- tk_xts(ma_SPL)
# merge(xts_price,xts_ma, join='inner')[,c(6:10)]
# xts.obj[paste(start.date,end.date,sep="::")]
# merge(xts_price, xts_ma, join = 'inner')[,c(6:10)][paste(format(input$dateRange[1]),format(input$dateRange[2]),sep="::")]

xprices <- function() {
  symbols <- ("^IRX")

  tq_get(symbols,
    get = "stock.prices",
    from = input$dateRange[1],
    to = input$dateRange[2]
  )
}
```

```{r rdsInput}
calendarDays              <- readRDS(here::here("rds", "calendarDays.rds"))
dtEMA                     <- readRDS(here::here("rds", "dtEMA.rds"))
golden                    <- readRDS(here::here("rds", "golden.rds"))
tradeDays                 <- readRDS(here::here("rds", "tradeDays.rds"))
trend                     <- data.table(readRDS(here::here("rds", "trend.rds")))
trendClose                <- readRDS(here::here("rds", "trendClose.rds"))
trendDraw                 <- data.table(readRDS(here::here("rds", "trendDraw.rds")))
trendReturns              <- data.table(readRDS(here::here("rds", "trendReturns.rds")))
trendReturnsAnnualized    <- data.table(readRDS(here::here("rds", "trendReturnsAnnualized.rds")))
trendReturnsDaily         <- readRDS(here::here("rds", "trendReturnsDaily.rds"))
trendSummary              <- data.table(readRDS(here::here("rds", "trendSummary.rds")))
trendSummaryEMA           <- data.table(readRDS(here::here("rds", "trendSummaryEMA.rds")))
xtsEMA                    <- readRDS(here::here("rds", "xtsEMA.rds"))
```

```{r processing}
trendname    <- str_sub(tail(trend[order(endDate)], 1)[, 2], end = -4)
trendname1   <- substr(tail(trend[order(endDate)], 1)[, 1], 1, 1)
# subset trend
d <- trend[substr(trend$catName, 1, 1) %like% "D"]
g <- trend[substr(trend$catName, 1, 1) %like% "G"]
n <- trend[substr(trend$catName, 1, 1) %like% "n"]
```

1.1 Summary {data-navmenu="1-Performance" data-icon="fa-list" data-orientation=rows}
=====================================  

Input {.sidebar}
-------------------------------------

```{r 1.0.0.1-sidebarInput}

dateRangeInput("dateRange",
  "Historical data",
  start = params$dateStart,
  end = Sys.Date()
)

# actionButton("go", "Submit")
```

```{r 1.0.0.1-sidebar-ActionGo}

tqPrices <- eventReactive(input$go, {
  tqPrices <- tq_get("SPL.AX",
    get = "stock.prices",
    from = format(input$dateRange[1]),
    to = format(input$dateRange[2])
  )
})


#  date        open  high   low close volume adjusted   change
price <- reactive({
  tq_get("SPL.AX", from = format(input$dateRange[1]), to = format(input$dateRange[2])) %>%
    mutate(
      change = close - open,
      ema020 = EMA(na.fill0(close, 0), 20),
      ema050 = EMA(na.fill0(close, 0), 50),
      ema100 = EMA(na.fill0(close, 0), 100),
      ema200 = EMA(na.fill0(close, 0), 200),
      sma020 = SMA(na.fill0(close, 0), 20),
      sma050 = SMA(na.fill0(close, 0), 50),
      sma100 = SMA(na.fill0(close, 0), 100),
      sma200 = SMA(na.fill0(close, 0), 200)
    )
})
```

Column {data-height=60}
-------------------------------------

###

```{r 1.1.1.1-vbox-calendar-days}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  calendarDays <- format(end(xts_price) - start(xts_price), big.mark = ",")
  calendarDays <- substr(calendarDays, 1, nchar(calendarDays) - 5)

  flexdashboard::valueBox(
    paste(calendarDays, "", " Calendar Days"),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

###

```{r 1.1.1.2-vbox-returns-annualized}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  annReturn <- percent((as.numeric(last(xts_price[, 4])) / as.numeric(first(xts_price[, 4])))^((1 / nyears(xts_price))) - 1)

  flexdashboard::valueBox(
    paste(as.character(annReturn), "", " Annualized Return"),
    color = ifelse(annReturn > 0, "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 1.1.1.3-vbox-returns-roi}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  cumReturn <- percent((as.numeric(last(xts_price[, 4])) - as.numeric(first(xts_price[, 4]))) / (as.numeric(first(xts_price[, 4]))))

  flexdashboard::valueBox(
    paste(as.character(cumReturn), "", " ROI"),
    color = ifelse(cumReturn > 0, "teal", "red"),
    icon = "ion-cash"
  )
})
```


###

```{r 1.1.1.4-vbox-trade-days}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  tradeDays <- format(ndays(xts_price), big.mark = ",")

  flexdashboard::valueBox(
    paste(tradeDays, "", " Trade Days"),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Row {data-height=200}
-------------------------------------

### Stock Price Table

```{r 1.1.2.1-table-Price}
DT::renderDataTable({
  DT::datatable(price(),
    rownames = FALSE,
    options = list(pageLength = 20, order = list(list(0, "desc")))
  ) %>%
    formatCurrency(c(
      "open", "high", "low", "close", "adjusted", "change",
      "ema020", "ema050", "ema100", "ema200", "sma020", "sma050", "sma100", "sma200"
    )) %>%
    formatDate(c("date")) %>%
    formatStyle("volume",
      background = styleColorBar(price()$volume, "steelblue")
    ) %>%
    formatStyle(
      "change",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

Row {data-height=200}
-------------------------------------

### Stock Price Over Time (Chart)
```{r  1.1.3.1-viz-Price, eval=price}
# y <- getSymbols("CSL.AX", auto.assign = FALSE)


renderHighchart({
  xts_price <- tk_xts(price())
  colnames(xts_price) <- paste0(input$ticker, ".", colnames(xts_price))
  highchart(type = "stock") %>%
    hc_add_series(xts_price, type = "candlestick")
  #    hc_add_series(RSI.BuyLevel, color = hex_to_rgba("blue", 0.7),
  #                yAxis = 2, name = "Buy level")
  #    hc_add_series(y, type = "ohlc")
})
```


### Distribution

```{r 1.1.3.2-viz-histogram, eval=price}

# draw a histogram
renderPlot({

  # generate bins based on input$bins from ui.R
  x <- tk_xts(price())
  hist(x[, 6],
    main = "Closing Price",
    xlab = "price",
    ylab = "Count",
    col = "darkmagenta",
    freq = TRUE,
    border = "white",
    xlim = c(0.0, 2),
    seq(0.1, 2, by = 0.10)
  )
})
```

1.2 Returns {data-navmenu="1-Performance" data-icon="ion-cash"}
=====================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### Daily Returns

```{r 1.2.1.a-viz-ret-Daily, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  dailyRet <- periodReturn(xts_price[, 6], period = "daily") * 100
  #  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>%
    hc_add_series(dailyRet, type = "column")
})
```

### Weekly Returns

```{r 1.2.1.b-viz-ret-Weekly, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  weeklyRet <- periodReturn(xts_price[, 6], period = "weekly") * 100
  #  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>%
    hc_add_series(weeklyRet, type = "column")
})
```

### Monthly Returns

```{r 1.2.1.c-viz-ret-monthly, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  monthlyRet <- periodReturn(xts_price[, 6], period = "monthly") * 100
  #  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>%
    hc_add_series(monthlyRet, type = "column")
})
```

### Quarterly Returns

```{r 1.2.1.d-viz-ret-quarterly, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  quarterlyRet <- periodReturn(xts_price[, 6], period = "quarterly") * 100
  #  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>%
    hc_add_series(quarterlyRet, type = "column")
})
```  

### Annual Returns

```{r 1.2.1.e-viz-ret-annual, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  annualRet <- periodReturn(xts_price[, 6], period = "yearly") * 100
  #  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>%
    hc_add_series(annualRet, type = "column")
})
```

### Future Returns

```{r 1.2.1.f-viz-ret-future, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  dailyRet <- periodReturn(xts_price[, 6], period = "daily")
  dailyRet[dailyRet == 0] <- NA
  dailyRet <- 1 + dailyRet
  fv <- cumprod(na.omit(dailyRet))
  highchart(type = "stock") %>%
    hc_add_series(fv, type = "line") %>%
    hc_add_theme(hc_theme_darkunica()) %>%
    hc_yAxis(
      title = list(text = "$1"),
      opposite = TRUE,
      plotLines = list(
        list(
          label = list(text = "This is a plotLine"),
          color = "blue",
          width = 3,
          value = 1.0
        )
      )
    )
})
```

2.1 Summary {data-navmenu="2-Trends" data-icon="fa-list"}
=====================================

Column {data-height=15%}
-------------------------------------

###

```{r 2.1.1.1-vbox-trend, eval=trend}

# https://is.gd/vb865W In flexdashboard, can a valueBox be clicked to update a text box like an actionButton?

flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("Current Trend:", " ", trendname),
    actionButton("button3", " ", style = "background-color:rgba(0, 0, 0, 0.0); border-color:rgba(0, 0, 0,           0.0); position: absolute; overflow: hidden; left: 0px; top: 0px; right: 0px; bottom: 0px;    
          width:100%"),
    color = ifelse(trendname1 == "D", "black",
      ifelse(trendname1 == "G", "teal",
        "purple"
      )
    ),
    icon = ifelse(trendname1 == "D", "fa-thumbs-down",
      ifelse(trendname1 == "G", "fa-thumbs-up",
        ifelse(trendname1 == "N" & return > 0,
          "fa-thumbs-up",
          "fa-thumbs-down"
        )
      )
    )
  )
})
```

###

```{r 2.1.1.2-vbox-days, eval=trend}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("Trade Days:", " ", format(tail(trend[order(endDate)], 1)[, 5], big.mark = ",")),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

###

```{r 2.1.1.3-vbox-returns-roi}
trendROI <- percent(tail(trend[order(endDate)], 1)[, 6][[1]],
  scale = 100, prefix = "", suffix = "%", big.mark = " ", decimal.mark = ".",
  trim = TRUE
)

flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(as.character(trendROI), "", " ROI"),
    color = ifelse(trendROI > 0, "teal",
      ifelse(trendROI < 0, "danger",
        "grey"
      )
    ),
    icon = ifelse(trendROI > 0, "fa-smile",
      ifelse(trendROI < 0, "fa-frown",
        "fa-meh-rolling-eyes"
      )
    )
  )
})
```

Column {data-height=50%, .tabset .tabset-fade}
-------------------------------------

### Trend Summary Table A

```{r 2.1.1.a-table-Trend}
DT::renderDataTable({
  DT::datatable(trend,
    rownames = FALSE,
    extensions = c("Scroller"),
    options = list(
      order = list(list(3, "desc")),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatPercentage("return") %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

### Trend Summary Table B

```{r 2.1.1.b-viz-ret-quarterly, eval=price}
renderHighchart({
  xts_price <- tk_xts(price())
  quarterlyRet <- periodReturn(xts_price[, 6], period = "quarterly") * 100
  #  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>%
    hc_add_series(quarterlyRet, type = "column")
})
```

### Trend Return Distribution C

```{r 2.1.1.c-viz-ret-quarterly, eval=trend}
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("D")))
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("Golden")))
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("n")))
```

### Trend Summary Table D
```{r 2.1.1.d-box-returns, eval=trend}
renderPlotly({
  p <- plot_ly(type = "box") %>%
    add_boxplot(
      y = d$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX Returns"
    ) %>%
    add_boxplot(
      y = g$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldeX Returns"
    ) %>%
    add_boxplot(
      y = n$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "n Returns"
    ) %>%
    add_boxplot(
      y = d$return, name = "Death Suspected Outlier", boxpoints = "suspectedoutliers",
      marker = list(
        color = "rgb(8,81,156)",
        outliercolor = "rgba(219, 64, 82, 0.6)",
        line = list(
          outliercolor = "rgba(219, 64, 82, 1.0)",
          outlierwidth = 2
        )
      ),
      line = list(color = "rgb(8,81,156)")
    ) %>%
    add_boxplot(
      y = g$return, name = "Golden Suspected Outlier", boxpoints = "suspectedoutliers",
      marker = list(
        color = "rgb(8,81,156)",
        outliercolor = "rgba(219, 64, 82, 0.6)",
        line = list(
          outliercolor = "rgba(219, 64, 82, 1.0)",
          outlierwidth = 2
        )
      ),
      line = list(color = "rgb(8,81,156)")
    ) %>%
    add_boxplot(
      y = n$return, name = "N Suspected Outlier", boxpoints = "suspectedoutliers",
      marker = list(
        color = "rgb(8,81,156)",
        outliercolor = "rgba(219, 64, 82, 0.6)",
        line = list(
          outliercolor = "rgba(219, 64, 82, 1.0)",
          outlierwidth = 2
        )
      ),
      line = list(color = "rgb(8,81,156)")
    ) %>%
    layout(title = "Box Plot Returns with Outliers")
})
```

### Trend Summary Table E
```{r 2.1.1.e-box-tradeDays, eval=trend}

renderPlotly({
  p <- plot_ly(type = "box") %>%
    add_boxplot(
      y = d$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX tradeDays"
    ) %>%
    add_boxplot(
      y = g$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldeX tradeDays"
    ) %>%
    add_boxplot(
      y = n$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "n tradeDays"
    ) %>%
    add_boxplot(
      y = d$tradeDays, name = "DeathX Suspected Outlier", boxpoints = "suspectedoutliers",
      marker = list(
        color = "rgb(8,81,156)",
        outliercolor = "rgba(219, 64, 82, 0.6)",
        line = list(
          outliercolor = "rgba(219, 64, 82, 1.0)",
          outlierwidth = 2
        )
      ),
      line = list(color = "rgb(8,81,156)")
    ) %>%
    add_boxplot(
      y = g$tradeDays, name = "GoldenX Suspected Outlier", boxpoints = "suspectedoutliers",
      marker = list(
        color = "rgb(8,81,156)",
        outliercolor = "rgba(219, 64, 82, 0.6)",
        line = list(
          outliercolor = "rgba(219, 64, 82, 1.0)",
          outlierwidth = 2
        )
      ),
      line = list(color = "rgb(8,81,156)")
    ) %>%
    add_boxplot(
      y = n$tradeDays, name = "N Suspected Outlier", boxpoints = "suspectedoutliers",
      marker = list(
        color = "rgb(8,81,156)",
        outliercolor = "rgba(219, 64, 82, 0.6)",
        line = list(
          outliercolor = "rgba(219, 64, 82, 1.0)",
          outlierwidth = 2
        )
      ),
      line = list(color = "rgb(8,81,156)")
    ) %>%
    layout(title = "Box Plot # of Trade Days with Outliers")
})
```

### Trend Summary Table G
```{r 2.1.1.g-box-tradeDays, eval=trend}
xhp <- list(title = d$catName, titlefont = f)
yhp <- list(title = "Counts", titlefont = f)
ybp <- list(title = d$catName, titlefont = f)

renderPlotly({
  histogramD <- plot_ly(d, x = d$tradeDays, type = "histogram") %>%
    layout(xaxis = xhp, yaxis = yhp)

  boxplotD <- plot_ly(d, x = d$tradeDays, type = "box", boxpoints = "all", jitter = 0.3) %>%
    layout(yaxis = ybp)
  subplot(boxplotD, histogramD, nrows = 2, shareX = TRUE) %>% layout(showlegend = FALSE)
})
```

Row {data-height=40%}
-------------------------------------
### Trend boxplot
```{r  2.1.2.1-viz-vboxplot, eval=trend}
renderPlotly({
  ggplotly(
    ggplot(trend, aes(x = substr(trend$catName, 1, nchar(trend$catName) - 3), y = return))
    + scale_y_continuous(labels = percent)
      + geom_boxplot(fill = "#0c4c8a")
      + theme_gray()
  )
})
```

### Trend Returns
```{r  2.1.2.2-viz-hboxplot, eval=trend}
renderHighchart({
  hcboxplot(
    x = trend$return * 100,
    var = substr(trend$catName, 1, nchar(trend$catName) - 3),
    name = "returns", color = "#2980b9", outliers = TRUE
  ) %>%
    hc_yAxis(labels = list(format = "{value}%"), min = -30, max = 30) %>%
    hc_add_theme(hc_theme_chalk())
})
```

### Trend Returns
```{r  2.1.2.3-viz-hboxplot, eval=trend}
renderHighchart({
  hcboxplot(
    x = trend$tradeDays,
    var = trend$catName,
    name = "returns",
    color = "#2980b9",
    outliers = TRUE
  ) %>%
    hc_chart(type = "column") %>% # to put box vertical
    hc_yAxis(labels = list(format = "{value}"), min = 0, max = 150) %>%
    hc_add_theme(hc_theme_chalk())
})
```


### Trend Returns
```{r  2.1.2.4-viz-pie, eval=trend}
trendStats <- trend[,
  .(
    N = .N,
    Mean = mean(tradeDays),
    SDev = sd(tradeDays),
    Median = median(tradeDays),
    Min = min(tradeDays),
    Max = max(tradeDays),
    count = sum(tradeDays)
  ),
  by = .(catName)
]

renderHighchart({
  highchart() %>%
    hc_chart(type = "column") %>%
    hc_add_series_labels_values(
      labels = trendStats$catName,
      values = trendStats$N
    ) %>%
    hc_add_theme(hc_theme_darkunica())
})
```

2.2 Golden Cross {data-navmenu="2-Trends" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 2.2.0.1-sidebarInput}

dateRangeInput("dateRange2.2",
  "Golden data",
  start = params$dateStart,
  end = Sys.Date()
)
```


```{r 2.2.0.2-sidebarRadio}
radioButtons("radio2.2", "Moving Avg:",
               c("Exponential" = 3,
                 "Simple" = 4)
)
```


Column {data-height=55%}
-------------------------------------

###

```{r 2.2.1.1-vbox-trendName}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("Golden Cross", str_sub(colnames(trendReturnsDaily[,as.numeric(input$radio2.2)]),-3, -1)),
    color = 'teal',
    icon = 'fa-cross'
  )
})
```

###

```{r 2.2.1.2-vbox-trendAnnReturn}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          Return.annualized(
            na.omit(trendReturnsDaily[,as.numeric(input$radio2.2)])[paste(format(input$dateRange2.2[1]),
              format(input$dateRange2.2[2]),sep = "::")]
          )
        )
      ), "", " Annual Return"
    ),
    color = ifelse(Return.annualized(
        na.omit(
          trendReturnsDaily[,as.numeric(input$radio2.2)])[paste(format(input$dateRange2.2[1]),
            format(input$dateRange2.2[2]),sep = "::")]) > 0, 
              "teal", "red"),    
    icon = "ion-cash"
  )
})
```

###

```{r 2.2.1.3-vbox-returns-cumulative}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          as.numeric(
            Return.cumulative(
              na.omit(trendReturnsDaily[,as.numeric(input$radio2.2)])[paste(format(input$dateRange2.2[1]),
                format(input$dateRange2.2[2]),sep = "::")]
            )
          )
        )
      ), "", " ROI"
    ),
    color = ifelse(Return.cumulative(
        na.omit(
          trendReturnsDaily[,as.numeric(input$radio2.2)])[paste(format(input$dateRange2.2[1]),
            format(input$dateRange2.2[2]),sep = "::")]) > 0, 
              "teal", "red"),    
    icon = "ion-cash"
  )
})
```

###

```{r 2.2.1.4-vbox-trendTradeDays, eval=trend}
flexdashboard::renderValueBox({
  tradeDays <-   as.character(ndays(
      na.omit(trendReturnsDaily[,as.numeric(input$radio2.2)])[paste(format(input$dateRange2.2[1]),
          format(input$dateRange2.2[2]),sep = "::")]
    )
  )
  flexdashboard::valueBox(
    paste("Trade Days: ", "", tradeDays),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------
### Golden Crossing Table

```{r 2.2.4.a-table-golden}
DT::renderDataTable({
  DT::datatable(trend[catName == "GoldenX"],
    rownames = FALSE,
    extensions = c("Scroller"),
    options = list(
      order = list(list(3, "desc")),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatPercentage("return") %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

2.3 Death Cross {data-navmenu="2-Trends" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 2.3.0.1-sidebarInput}

dateRangeInput("dateRange2.3",
  "DeathX data",
  start = params$dateStart,
  end = Sys.Date()
)
```

Row {data-height=15%}
-------------------------------------

###

```{r 2.3.1.1-vbox-trendName}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("Death Cross", ""),
    color = 'black',
    icon = 'fa-cross'
  )
})
```

###

```{r 2.3.1.2-vbox-trendAnnReturn}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(as.character(percent(as.numeric(Return.annualized(trendReturnsDaily)[,1]))), "", " Annual Return"),
    color = ifelse(as.numeric(Return.annualized(trendReturnsDaily)[,1]) > 0, "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.3.1.3-vbox-returns-cumulative}
cumReturn <- percent(as.numeric(Return.cumulative(trend[,6])))
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(as.character(percent(as.numeric(Return.cumulative(trendReturnsDaily)[,1]))), "", " Total Return"),
    color = ifelse(as.numeric(Return.cumulative(trendReturnsDaily)[,1]) > 0, "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.3.1.4-vbox-trendTradeDays, eval=trend}
flexdashboard::renderValueBox({
  tradeDays <- format(trend[catName == "DeathX", sum(tradeDays), by = catName][,2], big.mark = ",")
  flexdashboard::valueBox(
    paste("Trade Days: ", "", tradeDays),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Column {data-height=50%, data-width=500 .tabset .tabset-fade}
-------------------------------------

### DeathX Crossing Table

```{r 2.3.2.a-table-golden-five}
DT::renderDataTable({
  DT::datatable(trend[catName == "DeathX"],
    rownames = FALSE,
    extensions = c("Scroller"),
    options = list(
      order = list(list(3, "desc")),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatPercentage("return") %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

Row {data-height=35%}
-------------------------------------

### DeathX Cross Returns

```{r 2.3.1.1-xxx-death}
xhp <- list(title = d$catName, titlefont = F)
yhp <- list(title = "Counts", titlefont = F)
ybp <- list(title = d$catName, titlefont = F)

renderPlotly({
  histogramD <- plot_ly(d, x = d$tradeDays, type = "histogram", marker = list(color = "#D0A92C")) %>%
    layout(xaxis = xhp, yaxis = yhp)

  boxplotD <- plot_ly(d, x = d$tradeDays, type = "box", boxpoints = "all", jitter = 0.3, marker = list(color = "red", outliercolor = "#D0A92C", line = list(outliercolor = "#D0A92C", outlierwidth = 5))) %>%
    layout(yaxis = ybp)
  subplot(boxplotD, histogramD, nrows = 2, shareX = TRUE) %>%
    layout(showlegend = FALSE) %>%
    layout(title = "DeathX Box Plot & Histogram - # of Trade Days with Outliers", bargap = 0.1)
})

xhpG <- list(title = g$catName, titlefont = F)
yhpG <- list(title = "Counts", titlefont = F)
ybpG <- list(title = g$catName, titlefont = F)

renderPlotly({
  histogramG <- plot_ly(g, x = g$tradeDays, type = "histogram", marker = list(color = "lime")) %>%
    layout(xaxis = xhpG, yaxis = yhpG)

  boxplotG <- plot_ly(g, x = g$tradeDays, type = "box", color = "blue", boxpoints = "all", jitter = 0.3, marker = list(color = "black", outliercolor = "blue")) %>%
    layout(yaxis = ybpG)
  subplot(boxplotG, histogramG, nrows = 2, shareX = TRUE) %>%
    layout(showlegend = FALSE) %>%
    layout(title = "GoldenX Box Plot & Histogram - # of Trade Days with Outliers", bargap = 0.1)
})
```

2.4 No Cross {data-navmenu="2-Trends" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 2.4.0.1-sidebarInput}

dateRangeInput("dateRange2.4",
  "No Cross data",
  start = params$dateStart,
  end = Sys.Date()
)
```

Row {data-height=15%}
-------------------------------------

###

```{r 2.4.1.1-vbox-trendName}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("No Cross", ""),
    color = 'purple',
    icon = 'fa-cross'
  )
})
```

###

```{r 2.4.1.2-vbox-trendAnnReturn}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(as.character(percent(as.numeric(Return.annualized(trendReturnsDaily)[,5]))), "", " Annual Return"),
    color = ifelse(as.numeric(Return.annualized(trendReturnsDaily)[,5]) > 0, "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.4.1.3-vbox-returns-cumulative}
cumReturn <- percent(as.numeric(Return.cumulative(trend[,6])))
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(as.character(percent(as.numeric(Return.cumulative(trendReturnsDaily)[,5]))), "", " Total Return"),
    color = ifelse(as.numeric(Return.cumulative(trendReturnsDaily)[,5]) > 0, "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.4.1.4-vbox-trendTradeDays, eval=trend}
flexdashboard::renderValueBox({
  tradeDays <- format(trend[catName == "n", sum(tradeDays), by = catName][,2], big.mark = ",")
  flexdashboard::valueBox(
    paste("Trade Days: ", "", tradeDays),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```


Column {data-height=85%, data-width=500 .tabset .tabset-fade}
-------------------------------------

### NoX Crossing Table

```{r 2.4.2.a-table-golden-five}
DT::renderDataTable({
  DT::datatable(trend[catName == "n"],
    rownames = FALSE,
    extensions = c("Scroller"),
    options = list(
      order = list(list(3, "desc")),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatPercentage("return") %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

2.5 Box Plot {data-navmenu="2-Trends" data-icon="fa-list" data-orientation=rows}
=====================================

```{r 2.4.1.1-xxx-neither}
x   <- list(
  title                  = "Trend Name",
  titlefont              = F
)
y   <- list(
  title                  = "% Return",
  titlefont              = F
)

renderPlotly({
  p <- plot_ly(type        = "box") %>%
    add_boxplot(
      y                    = trend$return,
      x                    = ~ trend$catName,
      color                = ~ trend$catName,
      jitter               = 0.3,
      boxpoints            = "all",
      marker               = list(color = "rgb(7,40,89)"),
      line                 = list(color = "rgb(7,40,89)"),
      name                 = trend$catName) %>%          
      layout(
          title            = "GoldenX Box Plot & Histogram - # of Trade Days with Outliers"
            ,titlefont     = list(size = 15, color = 'white')
          ,xaxis           = list(
            color          = 'lime',
            tickangle      = -0,
            titlefont      = list(size = 20, color = 'white'),
            title          = "Trend Name", color = '#ffffff')
          ,yaxis           = list(
            titlefont      = list(size = 15, color = 'white'),
            title          = "% Return", color = '#ffffff')
          ,margin          = list(l = 100)
          ,plot_bgcolor    = '#5875D5'
          ,paper_bgcolor   = '#5875D5') %>%
    layout(yaxis           = list(tickformat = "%")
    )
})  
```

3.1 Summary {data-navmenu="3-TechnicalAnalysis" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 3.1.0.1-sidebar-ActionGo-TA}
dateRangeInput("dateRange3",
  "Historical data",
  start = params$dateStart,
  end = Sys.Date()
)
```

Column {}
-------------------------------------

### Gauge 3.1.1.1

```{r 3.1.1.1-vbox-gauge}
flexdashboard::renderGauge({
  gauge(60, min = 0, max = 100, symbol = "%")
})
```

### Gauge 3.1.1.2

```{r 3.1.1.2-vbox-gauge}
flexdashboard::renderGauge({
  gauge(60, min = 0, max = 100, symbol = "%")
})
```


### Gauge 3.1.1.3

```{r 3.1.1.3-vbox-gauge}
flexdashboard::renderGauge({
  xts_price <- tk_xts(price())
  cumReturn <- (as.numeric(last(xts_price[, 4])) - as.numeric(first(xts_price[, 4]))) / (as.numeric(first(xts_price[, 4])))

  gauge(cumReturn * 100, min = -100, max = 100, symbol = "%")
})
```

Column {}
-------------------------------------
### Stock Price Table

```{r 3.1.2.1-table-price}
DT::renderDataTable({
  DT::datatable(price(),
    rownames = FALSE,
    options = list(pageLength = 20, order = list(list(0, "desc")))
  ) %>%
    formatCurrency(c("open", "high", "low", "close", "adjusted", "change")) %>%
    formatDate(c("date")) %>%
    formatStyle("volume",
      background = styleColorBar(price()$volume, "steelblue")
    ) %>%
    formatStyle(
      "change",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

Column {.tabset .tabset-fade}
-------------------------------------
### Time Series
```{r 3.1.3.a-viz-time-series, eval=price}
renderPlot({
  xts_price <- tk_xts(price())
  chartSeries(xts_price, theme = chartTheme("black"), TA = "addCMF()")
})
```  

### Time Series 2
```{r 3.1.3.b-viz-time-series, eval=price}
renderPlot({
  xts_price <- tk_xts(price())
  chartSeries(xts_price, theme = chartTheme("white"), TA = "addMACD()")
})
```

### Time Series 3

```{r 3.1.3.c-viz-time-series, eval=xtsEMA}
renderPlot({
  chartSeries(xtsEMA[, 2],
    theme = chartTheme("black"),
    TA = c(
      addVo(),
      addBBands(),
      addEMA(n = 10, col = "blue")
    )
  )
})
```

4.1 Summary {data-navmenu="4-Forecast" data-icon="fa-list" data-orientation=rows}
=====================================

Column {.tabset .tabset-fade}
-------------------------------------

### Forecast Column1a

```{r 4.1.1.1-xxx}

```

Column
-------------------------------------

### Forecast Column2a

```{r 4.1.2.1-xxx}

```

5.1 Summary {data-navmenu="5-BackTesting" data-icon="fa-list" data-orientation=rows}
==========================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### BackTesting01a

```{r  5.1.1.1-table-ema, eval=price}
xtsEMA <- tk_xts(xtsEMA)
xtsEMA
```

5.2 Detail {data-navmenu="5-BackTesting" data-icon="fa-list" data-orientation=rows}
==========================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### Distribution 2

```{r 5.2.1.2-xxx, eval=price}
renderHighchart({

  # generate bins based on input$bins from ui.R
  x <- tk_xts(price())
  hist(x[, 6], col = "darkmagenta", freq = FALSE, border = "white", xlim = c(0, 2))
})
```

6.1 Summary {data-navmenu="6-WordCloud" data-icon="fa-list" data-orientation=rows}
=====================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### WordCloud01a

```{r 6.1.1.1-table-ret-category wordCloud01a}
trendReturns
```

6.2 Detail {data-navmenu="6-WordCloud" data-icon="fa-list" data-orientation=rows}
=====================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### WordCloud02a

```{r 6.2.1.a-table-dtEMA, eval=dtEMA}
dtEMA
```

### WordCloud02b

```{r 6.2.1.b-table-dtEMA, eval=trend}
trend
```
