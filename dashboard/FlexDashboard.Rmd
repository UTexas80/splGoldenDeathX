---
title: "Summary"
date: "`r params$reportdate`"
output:
  flexdashboard::flex_dashboard:
    orientation: row
    source_code: embed
    vertical_layout: fill
params:
  dateStart: "2002-01-02"
  dynamictitle: "My report"
  reportdate: !r Sys.Date()
  symbols: "SPL.AX"
  ticker: "SPL.AX"
runtime: shiny
theme: spacelab
---

```{r global, echo=FALSE, include=FALSE, message = FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
knitr::opts_knit$set(root.dir = "..", echo = FALSE)
library(data.table)
library(dplyr)
library(DT)
library(dygraphs)
library(flexdashboard)
library(formattable)
library(gt)
library(here)
library(highcharter)
library(hydroTSM)
library(PerformanceAnalytics)
library(plotly)
library(quantmod)
library(rmarkdown)
library(scales)
library(shiny)
library(shinybusy)
library(shinydashboard)
library(shinyWidgets)
library(tidyquant)
library(tidyverse)
library(timetk)
library(treemap)
library(utils)
library(xts)
library(zoo)

```

```{r functions}

# A function to build an xts object to hold both ticker returns.
# Function to calculate monthly returns on a stock
monthly_stock_returns <- function(ticker, dateStart) {
  
  # Download the data from Yahoo finance
  symbol <- getSymbols("SPL.AX", src = 'yahoo', from = "2019-07-02",
                       auto.assign = FALSE, warnings = FALSE)
  
  # Tranform it to monthly returns using the periodReturn function from quantmod
  data <- periodReturn("SPL.AX", period = 'monthly', type = 'log')

  # Let's rename the column of returns to something intuitive because the column
  # name is what will eventually be displayed on the time series graph
  colnames(data) <- as.character("SPL.AX")

  # We want to be able to work with the xts objects that result from this function
  # so let's explicitly put them to the global environment with an easy to use
  # name, the stock ticker
  assign("SPL_returns", data, .GlobalEnv)
}


xprices <- function() {

  symbols <- ("^IRX")
  
  tq_get(symbols,
         get = "stock.prices",
         from = input$dateRange[1],
         to = input$dateRange[2])
    
}
```

```{r rdsInput}
dtEMA <- readRDS(here::here("rds","dtEMA.rds"))
golden <- readRDS(here::here("rds","golden.rds"))
returnsByCategory <- readRDS(here::here("rds","returnsByCategory.rds"))
trend <-  data.table(readRDS(here::here("rds","trend.rds")))
xtsEMA <- readRDS(here::here("rds","xtsEMA.rds"))
```

Summary {data-navmenu="Performance"}
=====================================  

Input {.sidebar}
-------------------------------------
  
```{r sidebarInput}

dateRangeInput("dateRange",
               "Historical data",
               start = params$dateStart,
               end   = Sys.Date())

# actionButton("go", "Submit")

```

```{r sidebarActionGo}

tqPrices <- eventReactive(input$go, {
  
  tqPrices <- tq_get("SPL.AX", 
              get = "stock.prices",
              from = format(input$dateRange[1]),
              to = format(input$dateRange[2])) 
})


#  date        open  high   low close volume adjusted   change
price <- reactive({
  tq_get("SPL.AX", from = format(input$dateRange[1]), to = format(input$dateRange[2])) %>%
        mutate(change = close - open,
               ma020 = SMA(na.omit(Close),20)
              )
})

```

Column {data-height=60}
-------------------------------------

###

```{r vbox-calendar-days}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  calendarDays <- format(end(xts_price)-start(xts_price), big.mark = ",")
  calendarDays <- substr(calendarDays, 1, nchar(calendarDays)-5)
  
  flexdashboard::valueBox(
      paste(calendarDays, "", " Calendar Days")
      ,color = #0000ff
      ,icon = "fa-calendar"
  )
})

```

###

```{r vbox-returns-roi}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  cumReturn <- percent((as.numeric(last(xts_price[,4])) - as.numeric(first(xts_price[,4]))) / (as.numeric(first(xts_price[,4]))))

  flexdashboard::valueBox(
      paste(as.character(cumReturn), "", " ROI")
      ,color = ifelse(cumReturn > 0, "teal", "red")
      ,icon = 'ion-cash'
  )
})

```

###

```{r vbox-returns-annualized}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  annReturn <- percent((as.numeric(last(xts_price[,4])) / as.numeric(first(xts_price[,4]))) ^ ((1/nyears(xts_price)))-1)

  flexdashboard::valueBox(
      paste(as.character(annReturn), "", " Annualized Return")
      ,color = ifelse(annReturn > 0, "teal", "red")
      ,icon = 'ion-cash'
  )
})

```

###

```{r vbox-trade-days}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  tradeDays <- format(ndays(xts_price), big.mark = ",")

  flexdashboard::valueBox(
      paste(tradeDays, "", " Trade Days")
      ,color = #0000ff
      ,icon = "fa-calendar"
  )
})

```

Row {data-height=200}
-------------------------------------

### Stock Price Table

```{r tablePriceA}
DT::renderDataTable({
  DT::datatable(price(), rownames = FALSE, 
    options = list(pageLength = 20, order = list(list(0, 'desc')))) %>% 
    formatCurrency(c('open', 'high', 'low', 'close', 'adjusted', 'change')) %>% 
    formatDate(c('date')) %>%
    formatStyle('volume', 
      background = styleColorBar(price()$volume, 'steelblue')
    ) %>% 
    formatStyle(
      'change', 
      color = styleInterval(c(0), c('maroon', 'darkgreen'))
    )  
})
```

Row {data-height=200}
-------------------------------------

### Stock Price Over Time (Chart)
```{r chartPrice, eval=price}
# y <- getSymbols("CSL.AX", auto.assign = FALSE)


renderHighchart({
  xts_price <- tk_xts(price())
  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>% 
    hc_add_series(xts_price, type = "candlestick")
#    hc_add_series(RSI.BuyLevel, color = hex_to_rgba("blue", 0.7),
#                yAxis = 2, name = "Buy level") 
#    hc_add_series(y, type = "ohlc")
})

```


### Performance Summary

```{r performance-summary, eval=price}

renderPlot({
    xts_price <- tk_xts(price())
    xts_price_monthly <- xts_price[endpoints(xts_price, on ="months")]
    charts.PerformanceSummary(
      ROC(xts_price_monthly[,6], n = 1, type = "discrete")
      ,wealth.index = TRUE
      ,main = "SPL Performance Summary"
      ,theme = chartTheme("black")
    )
})  

```

Returns {data-navmenu="Performance"}
=====================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### Daily Returns

```{r eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  dailyRet<-periodReturn(xts_price[,6], period = 'daily') * 100
#  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>% 
    hc_add_series(dailyRet, type = "column")
})

``` 


### Weekly Returns

```{r eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  weeklyRet<-periodReturn(xts_price[,6], period = 'weekly') * 100
#  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>% 
    hc_add_series(weeklyRet, type = "column")
})

``` 


### Monthly Returns

```{r eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  monthlyRet<-periodReturn(xts_price[,6], period = 'monthly') * 100
#  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>% 
    hc_add_series(monthlyRet, type = "column")
})

``` 

### Quarterly Returns

```{r eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  quarterlyRet<-periodReturn(xts_price[,6], period = 'quarterly') * 100
#  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>% 
    hc_add_series(quarterlyRet, type = "column")
})

```  

### Annual Returns

```{r annual-return, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  annualRet<-periodReturn(xts_price[,6], period = 'yearly') * 100
#  colnames(xts_price) <- paste0(input$ticker,'.', colnames(xts_price))
  highchart(type = "stock") %>% 
    hc_add_series(annualRet, type = "column")
})

```

### Future Returns

```{r future-return, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  dailyRet<- periodReturn(xts_price[,6], period = 'daily')
  dailyRet[dailyRet==0]<- NA
  dailyRet <- 1 + dailyRet
  fv <- cumprod(na.omit(dailyRet))
  highchart(type = "stock") %>% 
  hc_add_series(fv, type = "line") %>%
  hc_add_theme(hc_theme_darkunica()) %>%
  hc_yAxis(title = list(text = "$1"),
         opposite = TRUE,
         plotLines = list(
           list(label = list(text = "This is a plotLine"),
                color = "blue",
                width = 3,
                value = 1.0)))
})

```

Summary {data-navmenu="Trends"}
=====================================
 
Row {data-height=200 .tabset .tabset-fade}
-------------------------------------

### Trend Summary Table A

```{r 02A-tableTrend}

DT::renderDataTable({
  DT::datatable(trend, rownames = FALSE, 
    options = list(pageLength = 10, order = list(list(0, 'desc')))) %>%
    formatDate(c('startDate', 'endDate')) %>%
    formatRound('count', 0) %>%
    formatPercentage('return')  %>%
    formatStyle('return', 
      background = styleColorBar(range(trend$return), 'lime'))%>%
    formatStyle('count', 
      color = styleInterval(c(0), c('maroon', 'darkgreen'))
    )  
})

```
### Trend Summary Table B

```{r 02b-tableTrend}
trend
```

Row {data-height=200}
-------------------------------------

### Trend Over Time (Chart)
```{r chartTrend, eval=xtsEMA}

```

Golden Cross {data-navmenu="Trends"}
=====================================

Input {.sidebar}
-------------------------------------
  
```{r sidebarInput2}

dateRangeInput("dateRange",
               "Historical data",
               start = params$dateStart,
               end   = Sys.Date())

actionButton("go", "Submit")

```

```{r sidebarGo2}
# We will use this in the table after the submit button is activated

prices <- eventReactive(input$go, {

  prices <- 
    getSymbols("SPL.AX", src = 'yahoo'
               ,from = format(input$dateRange[1])
               ,to = format(input$dateRange[2])
               ,auto.assign = TRUE
               ,warnings = FALSE) %>% 
    map(~Cl(get(.))) %>% 
    reduce(merge)

})
```

Row {data-height=260}
-------------------------------------

###

```{r vbox-golden-drawdown}
maxDrawdown(tk_xts(golden))
```

```{r vbox-golden-returns}
table.AnnualizedReturns(tk_xts(golden),Rf=0.02/252)
```

Row
-------------------------------------

### Golden Cross Performanct Summary

```{r chartSummaryReturns}

renderPlot({
    charts.PerformanceSummary(
      tk_xts(golden)
      ,Rf = 0.02
      ,main = "Golden Cross Performance Summary"
      ,geometric = FALSE
      
    )
})  
```

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### Stock Price Table

```{r tablePortfolioReturns}
renderTable({
  
  prices() %>%
    gt(
       rowname_col = "row"
    )
    
})  
```


### Golden Cross Performance Summary Table

```{r tableGoldenSummaryA}
DT::renderDataTable({
  DT::datatable(price(), rownames = FALSE, 
    options = list(pageLength = 20, order = list(list(0, 'desc')))) %>% 
    formatCurrency(c('open', 'high', 'low', 'close', 'adjusted', 'change')) %>% 
    formatDate(c('date')) %>%
    formatStyle('volume', 
      background = styleColorBar(price()$volume, 'steelblue')
    ) %>% 
    formatStyle(
      'change', 
      color = styleInterval(c(0), c('maroon', 'darkgreen'))
    )  
})
```


### Another Table

```{r tablePriceB}
DT::renderDataTable({
  DT::datatable(price(), rownames = FALSE, 
    options = list(pageLength = 20, order = list(list(0, 'desc')))) %>% 
    formatCurrency(c('open', 'high', 'low', 'close', 'adjusted', 'change')) %>% 
    formatDate(c('date')) %>%
    formatStyle('volume', 
      background = styleColorBar(price()$volume, 'steelblue')
    ) %>% 
    formatStyle(
      'change', 
      color = styleInterval(c(0), c('maroon', 'darkgreen'))
    )  
})
```


### Stock Price Table444

Death Cross {data-navmenu="Trends"}
=====================================

No Cross {data-navmenu="Trends"}
=====================================


TechnicalAnalysis
=====================================

Input {.sidebar}
-------------------------------------
  
```{r sidebarInput3}

dateRangeInput("dateRange3",
               "Historical data",
               start = params$dateStart,
               end   = Sys.Date())

```

Column {}
-------------------------------------

### Gauge 3.0
    
```{r}
flexdashboard::renderGauge({
    gauge(60, min = 0, max = 100, symbol = "%") 
  })
```

### Gauge 3.a
    
```{r}
flexdashboard::renderGauge({
    gauge(60, min = 0, max = 100, symbol = "%") 
  })
```


### Gauge 3.1
    
```{r}
flexdashboard::renderGauge({
  xts_price <- tk_xts(price())
  cumReturn <- (as.numeric(last(xts_price[,4])) - as.numeric(first(xts_price[,4]))) / (as.numeric(first(xts_price[,4])))
  
    gauge(cumReturn, min = -100, max = 100, symbol = "%") 
  })
```

Column {}
-------------------------------------
### Stock Price Table

```{r tablePriceB3}
DT::renderDataTable({
  DT::datatable(price(), rownames = FALSE, 
    options = list(pageLength = 20, order = list(list(0, 'desc')))) %>% 
    formatCurrency(c('open', 'high', 'low', 'close', 'adjusted', 'change')) %>% 
    formatDate(c('date')) %>%
    formatStyle('volume', 
      background = styleColorBar(price()$volume, 'steelblue')
    ) %>% 
    formatStyle(
      'change', 
      color = styleInterval(c(0), c('maroon', 'darkgreen'))
    )  
})
```



Column {.tabset .tabset-fade}
-------------------------------------
### Time Series
```{r eval=prices}
  renderPlot({
  xts_price <- tk_xts(price())
  chartSeries(xts_price, theme = chartTheme("black"),TA="addCMF()")
               
})
```  

### Time Series 2
```{r eval=prices}
  renderPlot({
  xts_price <- tk_xts(price())
  chartSeries(xts_price, theme = chartTheme("white"),TA="addMACD()")
               
})
```

### Time Series 3

```{r chartTrend3, eval=xtsEMA}
  renderPlot({
  chartSeries(xtsEMA[,2]
              ,theme = chartTheme("black")
              ,TA=c(
                addVo()
                ,addBBands()
                ,addEMA(n=10, col = "blue")
                ))
})

```

Forecast
=====================================

Column {.tabset .tabset-fade}
-------------------------------------

### Forecast Column1a


Column
-------------------------------------

### Forecast Column2a


BackTesting01 {data-navmenu="BackTesting"}
==========================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### BackTesting01a

```{r BackTesting01a-trend, eval=price}
  xtsEMA<-tk_xts(xtsEMA)
  xtsEMA
```

BackTesting02 {data-navmenu="BackTesting"}
==========================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### BackTesting02a

```{r BackTesting02a, eval=price}

```

WordCloud01 {data-navmenu="WordCloud"}
=====================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### WordCloud01a

```{r wordCloud01a}
returnsByCategory
```

WordCloud02 {data-navmenu="WordCloud"}
=====================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### WordCloud02a

```{r wordCloud02a}
dtEMA
```

### WordCloud02b

```{r wordCloud02b}
trend
```
