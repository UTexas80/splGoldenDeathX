---
title: "Performance Summary"
date: "`r params$reportdate`"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: embed
    vertical_layout: fill
params:
  dateStart: "2002-01-02"
  dynamictitle: "My report"
  reportdate: !r Sys.Date()
  ticker: "MSFT"
runtime: shiny
theme: spacelab
---

```{r global, echo=FALSE, include=FALSE, message = FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
knitr::opts_knit$set(root.dir = "..", echo = FALSE)
library(data.table)
library(dplyr)
library(DT)
library(dygraphs)
library(flexdashboard)
library(formattable)
library(highcharter)
library(hydroTSM)
library(PerformanceAnalytics)
library(plotly)
library(quantmod)
library(rmarkdown)
library(scales)
library(shiny)
library(shinydashboard)
library(tidyquant)
library(tidyverse)
library(timetk)
library(treemap)
library(utils)
library(xts)
library(zoo)


# Function to calculate monthly returns on a stock
monthly_stock_returns <- function(ticker, start_year) {
  # Download the data from Yahoo finance
  symbol <- getSymbols(ticker, src = 'yahoo', from = start_year,
                       auto.assign = FALSE, warnings = FALSE)
  # Tranform it to monthly returns using the periodReturn function from quantmod
  data <- periodReturn(symbol, period = 'monthly', type = 'log')

  # Let's rename the column of returns to something intuitive because the column
  # name is what will eventually be displayed on the time series graph
  colnames(data) <- as.character(ticker)

  # We want to be able to work with the xts objects that result from this function
  # so let's explicitly put them to the global environment with an easy to use
  # name, the stock ticker
  assign(ticker, data, .GlobalEnv)
}

```

Page 1
=====================================  

Input {.sidebar}
-------------------------------------
  
```{r}

dateRangeInput("dateRange",
               "Historical data",
               start = params$dateStart,
               end   = Sys.Date())

actionButton("go", "Submit")

prices <- eventReactive(input$go, {

prices <- getSymbols("SPL.AX", src = 'yahoo', 
          from = format(input$dateRange[1]),
          to = format(input$dateRange[2]),
          auto.assign = TRUE, warnings = FALSE) %>% 
          map(~Ad(get(.))) %>% 
          reduce(merge)

})

tqPrices <- eventReactive(input$go, {
  
  tqPrices <- tq_get("SPL.AX", 
              get = "stock.prices",
              from = format(input$dateRange[1]),
              to = format(input$dateRange[2])) 
    
})

    
```

Row {data-height=100}
-------------------------------------

### Number of Flexdashboard Calendar Days

```{r vbox-calendar-days, eval=prices}
cd <- readRDS("calendarDays.rds")
flexdashboard::valueBox(paste(format(cd, big.mark = ","), ""), caption = "# of Calendar Days", icon="fa-pencil")
#flexdashboard: valueBox(paste(format(ndays(prices), big.mark = ","), "days"), caption = "# of Trade Days", icon="fa-pencil")
```

### Number of ShinyDashboard Trade Days

```{r vbox-trade-days}
td <- readRDS("tradeDays.rds")
flexdashboard::valueBox(paste(format(td, big.mark = ","), "trading days"), caption = "# of Trade Days", icon="fa-pencil")
#flexdashboard::valueBox(paste(td, "days", sep = " "), icon="fa-pencil")
```

Row {data-height=500}
-------------------------------------
### Chart 4
```{r chartPlot, eval=tqPrices}
renderTable({
  tqPrices()
})
```


Page 2
=====================================     

### Chart 2.1
    
```{r}
flexdashboard::renderGauge({
    gauge(60, min = 0, max = 100, symbol = "%") 
  })
```
