---
title: "SPL Dashboard"
output:
  flexdashboard::flex_dashboard:
    orientation: row
    source_code: embed
    vertical_layout: fill
date: "`r params$reportdate`"
resource_files:
- dt_bb20_disp.rds  
- xts_bb20_disp.rds
- rds/calendarDays.rds
- rds/dt_trade_stats.rds
- rds/dtEMA.rds
- rds/dXema.rds
- rds/dXema_trade_stats.rds
- rds/dXsma.rds
- rds/dXsma_trade_stats.rds
- rds/golden.rds
- rds/goldenX_EMA_strategy.RData
- rds/goldenX_EMA.RData
- rds/gXema_trade_stats.rds
- rds/gXema.rds
- rds/gXsma.rds
- rds/nXema.rds
- rds/nXsma.rds
- rds/SPL.AX.rds
- rds/tradeDays.rds
- rds/trend.rds
- rds/trend.rds
- rds/trendReturns.rds
- rds/trendReturnsAnnualized.rds
- rds/trendReturnsSMA.rds
- rds/trendSummaryGroup.rds
- rds/xts_bb20_disp.rds
- SPL.AX/SPL.AX.rda
- rdata/SPL.AX.rda
runtime: shiny
theme: spacelab
params:
  dateEnd: !r Sys.Date()
  dateStart: '2002-01-02'
  dynamictitle: My report
  reportDate:
    input: date
    label: 'Report Date:'
    value: as.POSIXct(Sys.Date())
  symbols: SPL.AX
  ticker: SPL.AX
---

```{r global, echo=FALSE, include=FALSE, message = FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
knitr::opts_knit$set(root.dir = "..", echo = FALSE)
# library(d3heatmap)
library(blotter)
library(data.table)
library(dplyr)
library(DT)
library(dygraphs)
library(excelR)
library(FinancialInstrument)
library(flexdashboard)
library(formattable)
library(ggplot2)
library(grid)
library(gridExtra)
library(gt)
library(here)
library(highcharter)
library(hydroTSM)
library(knitr)
library(kableExtra)
library(lubridate)
library(magrittr)
library(PerformanceAnalytics)
library(plotly)
library(quantmod)
library(quantstrat)
library(readr)
library(rmarkdown)
library(scales)
library(shiny)
library(shinydashboard)
library(shinyWidgets)
library(stats)
library(stringr)
library(tidyquant)
library(tidyverse)
library(timetk)
library(treemap)
library(utils)
library(xts)
library(zoo)
```

```{r functions}

# A function to build an xts object to hold both ticker returns.
# Function to calculate monthly returns on a stock
monthly_stock_returns <- function(ticker, dateStart) {

  # Download the data from Yahoo finance
  symbol <- getSymbols("SPL.AX",
    src = "yahoo", from = "2019-07-02",
    auto.assign = FALSE, warnings = FALSE
  )

  # Transform it to monthly returns using the periodReturn function from quantmod
  data <- periodReturn("SPL.AX", period = "monthly", type = "log")

  # Let's rename the column of returns to something intuitive because the column
  # name is what will eventually be displayed on the time series graph
  colnames(data) <- as.character("SPL.AX")

  # We want to be able to work with the xts objects that result from this function
  # so let's explicitly put them to the global environment with an easy to use
  # name, the stock ticker
  assign("SPL_returns", data, .GlobalEnv)
} # monthly_stock_returns


# xts_price <- tk_xts(price())
# xts_ma <- tk_xts(ma_SPL)
# merge(xts_price,xts_ma, join='inner')[,c(6:10)]
# xts.obj[paste(start.date,end.date,sep="::")]
# merge(xts_price, xts_ma, join = 'inner')[,c(6:10)][paste(format(input$dateRange[1]),format(input$dateRange[2]),sep="::")]

xprices <- function() {
  symbols <- ("SPL.AX")

  tidyquant::tq_get(symbols,
    get = "stock.prices",
    from = input$dateRange[1],
    to = input$dateRange[2]
  )
}

# * Setup a ggplot cyberpunk theme ----

theme_cyberpunk <- function() {
  
  clrs <- colorRampPalette(c("#00ff9f", "#00b8ff", "#001eff", "#bd00ff", "#d600ff"))(7)

  clr_bg   <- "black"
  clr_bg2  <- "gray10"
  clr_grid <- "gray30"
  clr_text <- "#d600ff"
  
    theme(
        # Plot / Panel
        plot.background = element_rect(fill = clr_bg, colour = clr_bg),
        # plot.margin = margin(1.5, 2, 1.5, 1.5, "cm"),
        panel.background = element_rect(fill = clr_bg, color = clr_bg),
        # Grid
        panel.grid = element_line(colour = clr_grid, size = 1),
        panel.grid.major = element_line(colour = clr_grid, size = 1),
        panel.grid.minor = element_line(colour = clr_grid, size = 1),
        axis.ticks.x = element_line(colour = clr_grid, size = 1),
        axis.line.y = element_line(colour = clr_grid, size = 0.5),
        axis.line.x = element_line(colour = clr_grid, size = 0.5),
        # Text
        plot.title = element_text(colour = clr_text),
        plot.subtitle = element_text(colour = clr_text),
        axis.text = element_text(colour = clr_text),
        axis.title = element_text(colour = clr_text),
        # Legend
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_text(colour = clr_text),
        legend.text = element_text(colour = "gray80", size = 12, face = "bold"),
        # Strip
        strip.background = element_rect(fill = clr_bg2, color = clr_bg2)
    )
}

```

```{r rdsInput}
# buyHold_results         <- readRDS(here::here("rds", "buyHold_results.rds"))
calendarDays              <- readRDS(here::here("rds", "calendarDays.rds"))
dtEMA                     <- readRDS(here::here("rds", "dtEMA.rds"))
golden                    <- readRDS(here::here("rds", "golden.rds"))
# ------------------------------------------------------------------------------
dt_bb20_disp              <- data.table(readRDS(here::here("rds", "dt_bb20_disp.rds")))
dt_trade_stats            <- readRDS(here::here("rds", "dt_trade_stats.rds"))
# ------------------------------------------------------------------------------
dXema_trade_stats         <- readRDS(here::here("rds", "dXema_trade_stats.rds"))
dXsma_trade_stats         <- readRDS(here::here("rds", "dXsma_trade_stats.rds"))
gXema_trade_stats         <- readRDS(here::here("rds", "gXema_trade_stats.rds"))
gXsma_trade_stats         <- readRDS(here::here("rds", "gXsma_trade_stats.rds"))
# ------------------------------------------------------------------------------This is what feeds log.chart.Posn
SPL.AX                    <- na.omit(as.xts(readRDS(here::here("rds", "SPL.AX.rds"))),keep.rownames = TRUE)
# ------------------------------------------------------------------------------
tradeDays                 <- readRDS(here::here("rds", "tradeDays.rds"))
trend                     <- data.table(readRDS(here::here("rds", "trend.rds")))
# trendClose                <- readRDS(here::here("rds", "trendClose.rds"))
trendDraw                 <- data.table(readRDS(here::here("rds", "trendDraw.rds")))
# trendEMA                  <- data.table(readRDS(here::here("rds", "trendEMA.rds")))
trendReturns              <- data.table(readRDS(here::here("rds", "trendReturns.rds")))
trendReturnsAnnualized    <- data.table(readRDS(here::here("rds", "trendReturnsAnnualized.rds")))
trendReturnsDaily         <- readRDS(here::here("rds", "trendReturnsDaily.rds"))
trendReturnsEMAlong       <- data.table(readRDS(here::here("rds", "trendReturnsEMAlong.rds")))
trendReturnsSMA           <- data.table(readRDS(here::here("rds", "trendReturnsSMA.rds")))
trendReturnsSMAlong       <- data.table(readRDS(here::here("rds", "trendReturnsSMAlong.rds")))
# trendSMA                  <- data.table(readRDS(here::here("rds", "trendSMA.rds")))
# trendSummary            <- data.table(readRDS(here::here("rds", "trendSummary.rds")))
# ------------------------------------------------------------------------------
emaPct                    <- data.table(readRDS(here::here("rds", "emaPct.rds")))
smaPct                    <- data.table(readRDS(here::here("rds", "smaPct.rds")))  
trendSummaryGroup         <- data.table(readRDS(here::here("rds", "trendSummaryGroup.rds")))
# ------------------------------------------------------------------------------
xts_bb20_disp             <- as.xts(readRDS(here::here("rds", "xts_bb20_disp.rds")))
xtsEMA                    <- as.xts(readRDS(here::here("rds", "xtsEMA.rds")))
```

```{r quantstrat-environment}
# ------------------------------------------------------------------------------
rm(list = ls(.blotter), envir = .blotter)
# ------------------------------------------------------------------------------
if(!exists(".blotter"))    .blotter    <<- new.env()
if(!exists(".instrument")) .instrument <<- new.env()
if(!exists(".portfolio"))  .portfolio  <<- new.env()
if(!exists(".strategy"))   .strategy   <<- new.env()
# ------------------------------------------------------------------------------
```

```{r blotter-rds}
# ------------------------------------------------------------------------------
dXema                     <- readRDS(here::here("rds", "dXema.rds"))
dXsma                     <- readRDS(here::here("rds", "dXsma.rds"))
# ------------------------------------------------------------------------------
gXema                     <- readRDS(here::here("rds", "gXema.rds"))
gXsma                     <- readRDS(here::here("rds", "gXsma.rds"))
# ------------------------------------------------------------------------------
nXema                     <- readRDS(here::here("rds", "nXema.rds"))
nXsma                     <- readRDS(here::here("rds", "nXsma.rds"))
# ------------------------------------------------------------------------------
```

```{r financial-instruments}
# ------------------------------------------------------------------------------
# Sys.setenv(TZ = 'America/New_York')
# ------------------------------------------------------------------------------
# curr       <- FinancialInstrument::currency("AUD")
# get_curr   <- FinancialInstrument::getInstrument("AUD")
# ------------------------------------------------------------------------------
# stk        <- FinancialInstrument::stock("SPL.AX", "AUD")
# sphrf      <- FinancialInstrument::getInstrument("SPL.AX")
# sphry      <- get("SPL.AX", envir  = FinancialInstrument:::.instrument)
# SPL.AX     <- FinancialInstrument::getInstrument("SPL.AX")
# SPL.AX     <- get("SPL.AX", envir  = FinancialInstrument:::.instrument)
# ------------------------------------------------------------------------------
# FinancialInstrument::currency(c("AUD", "USD"))           # Set the currency  ###
# exchange_rate("USDAUD")
# ------------------------------------------------------------------------------
# FinancialInstrument::stock(c("SPL.AX"), currency ="AUD") # Define the stocks ###
# FinancialInstrument::getInstrument("SPL.AX")
```

```{r blotter-accounts}
# ------------------------------------------------------------------------------
dXema                     <- blotter::put.account("dXema", dXema, envir = .blotter)
dXsma                     <- blotter::put.account("dXsma", dXsma, envir = .blotter)
# ------------------------------------------------------------------------------
gXema                     <- blotter::put.account("gXema", gXema, envir = .blotter)
gXsma                     <- blotter::put.account("gXsma", gXsma, envir = .blotter)
# ------------------------------------------------------------------------------
nXema                     <- blotter::put.account("nXema", nXema, envir = .blotter)
nXsma                     <- blotter::put.account("nXsma", nXsma, envir = .blotter)
# ------------------------------------------------------------------------------
```

```{r blotter-portfoliios}
# ------------------------------------------------------------------------------
dXema                     <- blotter::put.portfolio("dXema", dXema, envir = .blotter)
dXsma                     <- blotter::put.portfolio("dXsma", dXsma, envir = .blotter)
# ------------------------------------------------------------------------------
gXema                     <- blotter::put.portfolio("gXema", gXema, envir = .blotter)
gXsma                     <- blotter::put.portfolio("gXsma", gXsma, envir = .blotter)
# ------------------------------------------------------------------------------
nXema                     <- blotter::put.portfolio("nXema", nXema, envir = .blotter)
nXsma                     <- blotter::put.portfolio("nXsma", nXsma, envir = .blotter)
# ------------------------------------------------------------------------------
```

```{r processing}
trendname    <- str_sub(tail(trend[indicator=='SMA'][order(endDate)], 1)[, 1], end = -4)
trendname1   <- substr(tail(trend[order(endDate)], 1)[, 1], 1, 1)
# subset trend
d <- trend[substr(trend$catName, 1, 1) %like% "D"]
dEMA <- d[indicator == 'EMA']
dSMA <- d[indicator == 'SMA']
g <- trend[substr(trend$catName, 1, 1) %like% "G"]
n <- trend[substr(trend$catName, 1, 1) %like% "N"]
```

```{R daydiff functions, include=FALSE, warning=FALSE, cache=FALSE}

dayDifff <- function(X)
{
    as.numeric(as.Date(index(X))) - c(NA, as.numeric(as.Date(index(X[-nrow(X)]))))
}
```

1.1 Summary {data-navmenu="1-Performance" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 1.0.0.1-sidebarInput}
dateRangeInput("dateRange",
  "Historical data",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

Welcome to the SPL Golden Crossing Dashboard!

**Mission:** utilize Machine Learning & Fintech analytics to vette the ASX for compelling Small Cap Biotech risk adverse trading opportunities.

**Objective:** The purpose of this dashboard is twofold.

1. To provide a glimpse of Starpharma's performance circa 2002-01-02.
2. To examine the Golden Cross, Death Cross and No Cross Trading Strategies to discern their viability.

**Design:** This site is developed using a reactive framework thereby allowing a dynamic interaction with any of the input variables. Therefore, whenever the date is updated the corresponding entries will be dynamically updated as well.

As a side note, to formulate the Crossing Trading Systems, the annualized return and ROI formulas are based upon the 20, 50, 100- and 200-day moving averages. Hence any dates selected with a start date less than 200 trading days prior to today, i.e., in the range from  `` `r head(tail(index(xtsEMA),200),1)` `` to `` `r Sys.Date()` `` will generate an error. I am currently working on a solution.

If you have any questions, or would like to provide feedback please: [email me](mailto:utexas80@gmail.com)

Thank you for your time and consideration. I hope that you enjoy the site.

RISKS ASSOCIATED WITH TRADING THE STOCK MARKET

All investments involve risk, and the past performance of a security, industry, sector, market, financial product, trading strategy, or individualâ€™s trading does not guarantee future results or returns. Investors are fully responsible for any investment decisions they make. Such decisions should be based solely on an evaluation of their financial circumstances, investment objectives, risk tolerance, and liquidity needs.

Any opinions, news, research, analyses, prices, or other information offered is provided as general market commentary, and does not constitute investment advice. I will not accept liability for any loss or damage, including without limitation any loss of profit, which may arise directly or indirectly from use of or reliance on such information.

```{r 1.0.0.1-sidebar-ActionGo}

tqPrices <- eventReactive(input$go, {
  tqPrices <- tidyquant::tq_get("SPL.AX",
    get = "stock.prices",
    from = format(input$dateRange[1]),
    to = format(input$dateRange[2])
  )
})

#  date        open  high   low close volume adjusted   change
price <- reactive({
  tidyquant::tq_get("SPL.AX",
    from = format(input$dateRange[1]),
    to = format(input$dateRange[2])) %>%
    mutate(
      change = close - open,
      ema020 = EMA(na.fill0(close, 0), 20),
      ema050 = EMA(na.fill0(close, 0), 50),
      ema100 = EMA(na.fill0(close, 0), 100),
      ema200 = EMA(na.fill0(close, 0), 200),
      sma020 = SMA(na.fill0(close, 0), 20),
      sma050 = SMA(na.fill0(close, 0), 50),
      sma100 = SMA(na.fill0(close, 0), 100),
      sma200 = SMA(na.fill0(close, 0), 200)
    )
})
```

Column {data-height=60}
-------------------------------------

###

```{r 1.1.1.1-vbox-calendar-days}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())

  calendarDays <- format(end(xts_price) - start(xts_price), big.mark = ",")
  calendarDays <- substr(calendarDays, 1, nchar(calendarDays) - 5)

  flexdashboard::valueBox(
    paste(calendarDays, "", " Calendar Days"),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

###

```{r 1.1.1.2-vbox-returns-annualized}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  annReturn <- percent((as.numeric(last(xts_price[, 4])) / as.numeric(first(xts_price[, 4])))^((1 / nyears(xts_price))) - 1)

  flexdashboard::valueBox(
    paste(as.character(annReturn), "", " Annualized Return"),
    color = ifelse(annReturn > 0, "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 1.1.1.3-vbox-returns-cumulative}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  cumReturn <- percent((as.numeric(last(xts_price[, 4])) - as.numeric(first(xts_price[, 4]))) / (as.numeric(first(xts_price[, 4]))))

  flexdashboard::valueBox(
    paste(as.character(cumReturn), "", " Cumulative"),
    color = ifelse(cumReturn > 0, "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 1.1.1.4-vbox-trade-days}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  tradeDays <- format(ndays(xts_price), big.mark = ",")

  flexdashboard::valueBox(
    paste(tradeDays, "", " Trade Days"),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Row {data-height=200}
-------------------------------------

### Stock Price Table

```{r 1.1.2.1-table-Price}
DT::renderDataTable({
  DT::datatable(price()[,-c(1,8:9)],
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr'
      ,order = list(list(0, "desc"))
      ,pageLength = 20
      ,scrollX = TRUE
      ,scrollY = 280
      ,scroller = TRUE)
    ) %>%
    formatCurrency(c(
      "open", "high", "low", "close",
      "ema020", "ema050", "ema100", "ema200", "sma020", "sma050", "sma100", "sma200"
    )) %>%
    formatCurrency('volume', currency = "", interval = 3, mark = ",", digits=0)  %>%
    formatDate(c("date")) %>%
    formatStyle("volume",
      background = styleColorBar(price()$volume, "steelblue")
    )
})
```

Row {data-height=200}
-------------------------------------

### Historical Stock Prices

```{r  1.1.3.1-viz-candlestick-price, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  colnames(xts_price) <- paste0(input$ticker, ".", colnames(xts_price))
  highchart(type = "stock") %>%
    hc_add_series(xts_price, type = "candlestick")
})
```

### Closing Price Historgram

```{r 1.1.3.2-viz-histogram-close, eval=price}

# draw a histogram
renderPlot({

  # generate bins based on input$bins from ui.R
  x <- tk_xts(price())
  y <- max(SPL.AX[,6])
  
  hist(x[,6],
    main = "Closing Price",
    xlab = "price",
    ylab = "Count",
    col = "blue",
    freq = TRUE,
    border = "white",
    xlim = c(0.0, y),
    seq(0.1, 2.5, by = 0.10)
  )
})
```

1.2 Returns {data-navmenu="1-Performance" data-icon="ion-cash"}
=====================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### Daily Returns

```{r 1.2.1.1-viz-ret-Daily, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  dailyRet <- periodReturn(xts_price[, 6], period = "daily") * 100
  highchart(type = "stock") %>%
    hc_add_series(dailyRet, type = "column")
})
```

### Weekly Returns

```{r 1.2.1.2-viz-ret-Weekly, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  weeklyRet <- periodReturn(xts_price[, 6], period = "weekly") * 100
  highchart(type = "stock") %>%
    hc_add_series(weeklyRet, type = "column")
})
```

### Monthly Returns

```{r 1.2.1.3-viz-ret-monthly, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  monthlyRet <- periodReturn(xts_price[, 6], period = "monthly") * 100
  highchart(type = "stock") %>%
    hc_add_series(monthlyRet, type = "column")
})
```

### Quarterly Returns

```{r 1.2.1.4-viz-ret-quarterly, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  quarterlyRet <- periodReturn(xts_price[, 6], period = "quarterly") * 100
  highchart(type = "stock") %>%
    hc_add_series(quarterlyRet, type = "column")
})
```

### Annual Returns

```{r 1.2.1.5-viz-ret-annual, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  annualRet <- periodReturn(xts_price[, 6], period = "yearly") * 100
  highchart(type = "stock") %>%
    hc_add_series(annualRet, type = "column")
})
```

### $1 Invested

```{r 1.2.1.6-viz-ret-future, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  dailyRet <- periodReturn(xts_price[, 6], period = "daily")
  dailyRet[dailyRet == 0] <- NA
  dailyRet <- 1 + dailyRet
  fv <- cumprod(na.omit(dailyRet))
  highchart(type = "stock") %>%
    hc_add_series(fv, type = "line") %>%
    hc_add_theme(hc_theme_darkunica()) %>%
    hc_yAxis(
      title = list(text = "$1"),
      opposite = TRUE,
      plotLines = list(
        list(
          label = list(text = "This is a plotLine"),
          color = "blue",
          width = 3,
          value = 1.0
        )
      )
    )
})
```

### Chaikan Money Flow

```{r 1.2.1.7-viz-chaikan-money-flow, eval=price}

renderPlot({
  x <- tk_xts(price())
  chartSeries(x, theme = 'black',subset = '2001::', TA = "addBBands();addVo();addCMF();addZLEMA()")   #Year 2001 To Present
})

```

2.1 Summary {data-navmenu="2-Trends" data-icon="fa-list"}
=====================================

Column {data-height=21%}
-------------------------------------

###

```{r 2.1.1.1.a-vbox-trendName, eval=trend}

# https://is.gd/vb865W In flexdashboard, can a valueBox be clicked to update a text box like an actionButton?

trendnameEMA    <- tail(trend[indicator == 'EMA'][order(endDate)], 1)[, 2]
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("EMA Current Trend:", " ", trendnameEMA),
    actionButton("button3", " ",
    style = "background-color:rgba(0, 0, 0, 0.0);
      border-color:rgba(0, 0, 0, 0.0);
      position: absolute;
      overflow: hidden;
      left: 0px;
      top: 0px;
      right: 0px;
      bottom: 0px;
      width:100%"),
    color = ifelse(trendname1 == "D", "black",
      ifelse(trendname1 == "G", "teal",
        "purple"
      )
    ),
    icon = ifelse(trendname1 == "D", "fa-thumbs-down",
      ifelse(trendname1 == "G", "fa-thumbs-up",
        ifelse(trendname1 == "n" & trend$return > 0,
          "fa-thumbs-up",
          "fa-thumbs-down"
        )
      )
    )
  )
})
```

```{r 2.1.1.1.b-vbox-trend, eval=trend}

# https://is.gd/vb865W In flexdashboard, can a valueBox be clicked to update a text box like an actionButton?

trendnameSMA    <- tail(trend[indicator == 'SMA'][order(endDate)], 1)[, 2]
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("SMA Current Trend:", " ", trendnameSMA),
    actionButton("button3", " ",
    style = "background-color:rgba(0, 0, 0, 0.0);
      border-color:rgba(0, 0, 0, 0.0);
      position: absolute;
      overflow: hidden;
      left: 0px;
      top: 0px;
      right: 0px;
      bottom: 0px;
      width:100%"),
    color = ifelse(trendname1 == "D", "black",
      ifelse(trendname1 == "G", "teal",
        "purple"
      )
    ),
    icon = ifelse(trendname1 == "D", "fa-thumbs-down",
      ifelse(trendname1 == "G", "fa-thumbs-up",
        ifelse(trendname1 == "n" & trend$return > 0,
          "fa-thumbs-up",
          "fa-thumbs-down"
        )
      )
    )
  )
})
```

###

```{r 2.1.1.2.a-vbox-returns-roi, eval=trend}
trendROIema <- percent(tail(trend[order(endDate)][indicator == 'EMA'],1)[,8][[1]])

flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("EMA ROI:", " ", as.character(trendROIema)),
    color = ifelse(trendROIema > 0, "teal",
      ifelse(trendROIema < 0, "danger",
        "grey"
      )
    ),
    icon = ifelse(trendROIema > 0, "fa-smile",
      ifelse(trendROIema < 0, "fa-frown",
        "fa-meh-rolling-eyes"
      )
    )
  )
})
```

```{r 2.1.1.2.b-vbox-returns-roi, eval=trend}
trendROI <- percent(tail(trend[order(endDate)][indicator == 'SMA'],1)[,8][[1]])

flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("SMA ROI:", " ", as.character(trendROI)),
    color = ifelse(trendROI > 0, "teal",
      ifelse(trendROI < 0, "danger",
        "grey"
      )
    ),
    icon = ifelse(trendROI > 0, "fa-smile",
      ifelse(trendROI < 0, "fa-frown",
        "fa-meh-rolling-eyes"
      )
    )
  )
})
```

###

```{r 2.1.1.3.a-vbox-trade-days, eval=trend}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("EMA Trade Days:", " ", format(tail(trend[indicator=='EMA'][order(endDate)], 1)[, 11], big.mark = ",")),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

```{r 2.1.1.3.b-vbox-trade-days, eval=trend}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("SMA Trade Days:", " ", format(tail(trend[indicator=='SMA'][order(endDate)], 1)[, 11], big.mark = ",")),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Column {data-height=50%, .tabset .tabset-fade}
-------------------------------------

### Trend Summary Table

```{r 2.1.2.1-table-Trend, eval=trend}
DT::renderDataTable({
  DT::datatable(trend[,-c(9,13:16)],
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr',
      order = list(list(5, "desc"), list(0, 'asc')),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 300,
      scroller = TRUE
    )
  ) %>%
    formatCurrency(
      c("startOpen", "endOpen"),
        digits = 2
    ) %>%
    formatCurrency(
      c("Net.Trading.PL"),
        digits = 0
    ) %>%  
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatPercentage("return",2) %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

### Composite Trade Stats

```{r 2.1.2.2-table-tradestats, eval=dt_trade_stats}
# goldenX_EMA_tradestats <- blotter::tradeStats(
#   "goldenX_EMA_portfolio",
#     Dates =
#       paste(format(input$dateRange2.2[1]),format(input$dateRange2.2[2]),sep = "::"))

DT::renderDataTable({
  DT::datatable(dt_trade_stats[,-2],
    rownames = FALSE,
    extensions = c("Scroller"),
#    filter = 'top',
    options = list(
      dom = 'ltipr',
      order = list(list(3, "desc")),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatCurrency(
      c("Net.Trading.PL", "Avg.Trade.PL", "Med.Trade.PL",
        "Largest.Winner", "Largest.Loser",
        "Gross.Profits", "Gross.Losses",
        "Avg.Win.Trade", "Med.Win.Trade",  
        "Avg.Losing.Trade", "Med.Losing.Trade",
        "Avg.Daily.PL", "Med.Daily.PL",
        "Max.Drawdown", "Max.Equity", "Min.Equity", "End.Equity"
       ),
        digits = 0
    ) %>%
    formatPercentage(
      c("Percent.Positive", "Percent.Negative")
    ) %>%
    formatRound(
      c("Std.Dev.Trade.PL",   "Std.Err.Trade.PL", "Profit.Factor",
        "Std.Dev.Daily.PL",   "Std.Err.Daily.PL", "Ann.Sharpe",
        "Profit.To.Max.Draw", "Avg.WinLoss.Ratio", "Med.WinLoss.Ratio"
      ),
        digits = 2
    )
})
```

### EMA Trend Return Distribution

```{r 2.1.2.3-viz-box-returns, eval=trendReturns}
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("D")) %>% select(ends_with("EMA")))
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("G")) %>% select(ends_with("EMA")))
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("N")) %>% select(ends_with("EMA")))
```

### SMA Trend Return Distribution

```{r 2.1.2.4-viz-box-returns, eval=trendReturns}
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("D")) %>% select(ends_with("SMA")))
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("G")) %>% select(ends_with("SMA")))
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("N")) %>% select(ends_with("SMA")))
```

### Composite Returns

```{r 2.1.2.5-viz-box-returns, eval=trend}
renderPlotly({
  p <- plot_ly(type = "box") %>%
    add_boxplot(
      y = d$return,
      jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX Returns"
    ) %>%
    add_boxplot(
      y = g$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldeX Returns"
    ) %>%
    add_boxplot(
      y = n$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "n Returns"
    ) %>%
    layout(title = "Composite Returns - EMA + SMA",
          yaxis = list(
          title = 'Return Percentage ',
          tickformat = "%")
    )
})
```

### Returns by MA Type

```{r 2.1.2.6-viz-box-returns, eval=trend}
gSMA = g[indicator == 'SMA']
nSMA = n[indicator == 'SMA']

renderPlotly({
  p <- plot_ly(type = "box") %>%
    add_boxplot(
#      x = d[indicator == 'EMA'],
      y = dEMA$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX-EMA"
    ) %>%
    add_boxplot(
      d = d[indicator == 'SMA'],
      y = d$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX-SMA"
    ) %>%
    add_boxplot(
      g = g[indicator == 'EMA'],
      y = g$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldenX-EMA"
    ) %>%
    add_boxplot(
      y = gSMA$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldenX-SMA"
    ) %>%
    add_boxplot(
      n = n[indicator == 'EMA'],
      y = n$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "No X-EMA"
    ) %>%
    add_boxplot(
      y = nSMA$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "No X-SMA"
    ) %>%
    layout(title = "Returns by Moving Average Type",
      yaxis = list(
      title = 'Return Percentage ',
      tickformat = "%")
    )
})
```

### Composite Trade Days

```{r 2.1.2.7-viz-box-trade-days, eval=trend}

renderPlotly({
  p <- plot_ly(type = "box") %>%
    add_boxplot(
      y = d$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX tradeDays"
    ) %>%
    add_boxplot(
      y = g$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldeX tradeDays"
    ) %>%
    add_boxplot(
      y = n$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "n tradeDays"
    ) %>%
      layout(title = "Composite Trade Days - EMA + SMA",
          yaxis = list(
          title = 'Trade Days')
    )
})
```

### Trade Days by MA Type

```{r 2.1.2.8-viz-box-trade-days, eval=trend}
gSMA = g[indicator == 'SMA']
nSMA = n[indicator == 'SMA']

renderPlotly({
  p <- plot_ly(type = "box") %>%
    add_boxplot(
      y = dEMA$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX-EMA"
    ) %>%
    add_boxplot(
      d = d[indicator == 'SMA'],
      y = dSMA$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX-SMA"
    ) %>%
    add_boxplot(
      g = g[indicator == 'EMA'],
      y = g$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldenX-EMA"
    ) %>%
    add_boxplot(
      y = gSMA$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldenX-SMA"
    ) %>%
    add_boxplot(
      n = n[indicator == 'EMA'],
      y = n$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "No X-EMA"
    ) %>%
    add_boxplot(
      y = nSMA$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "No X-SMA"
    ) %>%
      layout(title = "Trade Days by Moving Average Type",
          yaxis = list(
          title = 'Trade Days')
    )
})
```

Row {data-height=33%}
-------------------------------------

### Composite Trend Return Distribution

```{r  2.1.3.1-viz-vboxplot, eval=trend}

renderPlotly({
  ggplotly(
    ggplot(trend, aes(x = paste0(trend$catName, "-", trend$indicator), y = return))
    + scale_y_continuous(labels = percent)
    + geom_boxplot(fill = "#0c4c8a")
    + theme_gray()
    + theme(axis.title.x=element_blank()
          ,axis.text.x = element_text(
            angle = 0
            , vjust = 0
            , size = 8
            , hjust = 1
            , face = "bold")
          )
  )
})
```

### Trend Returns Annualized

```{r 2.1.3.2-viz-pie, eval=trendReturnsAnnualized}
m <- melt(trendReturnsAnnualized[1,], id.vars = c("rn"))[,-1]
names(m) <- c("trend", "return")
m <- m[-7, `:=`(trend=str_sub(trend, end = -4), indicator= str_sub(trend, -3, -1))]
mEMA <- m[indicator=='EMA']
mSMA <- m[indicator=='SMA']
renderPlotly({
   p <- plot_ly(type = "bar") %>%
     add_bars(mEMA, x = ~mEMA$trend, y = ~mEMA$return, text = ~mEMA$indicator, textposition = 'auto',
               marker = list(color =
                   c('black'
                   ,'teal'
                   ,'purple'))) %>%
     add_bars(mSMA, x = ~mSMA$trend, y = ~mSMA$return, text = ~mSMA$indicator, textposition = 'auto',
               marker = list(color =
                   c('black'
                   ,'teal'
                   ,'purple'
                   ))) %>%
     layout(
       xaxis = list(title = ""),
       yaxis = list(
         title = 'Percent',
         tickformat = "%"),
       barmode = 'group', bargap = 0.15, bargroupgap = 0.1,
       showlegend = FALSE)

})
```

### Trend Trade Days Distribution

```{r 2.1.3.3-viz-barchart, eval=trendSummaryGroup}

# emaPct <- trendSummaryGroup[1:3, occurrencePct := count/sum(count)][1:3, tradeDaysPct := tradeDays/sum(tradeDays)][1:3, c(2:5,8,7)]
# smaPct <- trendSummaryGroup[4:6, occurrencePct := count/sum(count)][4:6, tradeDaysPct := tradeDays/sum(tradeDays)][4:6, c(2:5,8,7)]

renderPlotly({
    p <- plot_ly(type = "bar") %>%
      add_bars( x = emaPct$catName, y = emaPct$tradeDaysPct, text = ~emaPct$indicator, textposition = 'auto',
                marker = list(color =
                  c('rgba(0,0,0,1)'
                    ,'teal'
                    ,'purple'))) %>%
      add_bars( x = smaPct$catName, y = smaPct$tradeDaysPct, text = ~smaPct$indicator, textposition = 'auto',
                marker = list(color =
                  c('rgba(0,0,0,1)'
                    ,'teal'
                    ,'purple'))) %>%

      layout(
          yaxis = list(
          title = 'Percent',
          tickformat = "%"),
        barmode = 'group', bargap = 0.15, bargroupgap = 0.1,
        showlegend = F)

})
```

2.2 Golden Cross {data-navmenu="2-Trends" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 2.2.0.1-sidebarInput}

dateRangeInput("dateRange2.2",
  "Golden Crossing Date",
  start = params$dateStart,
  end = Sys.Date()
)
```

```{r 2.2.0.2-sidebarRadio}
radioButtons("radio2.2", "Moving Avg:",
               c("Exponential" = 3,
                 "Simple" = 4)
)
```

_____________________________
**Trade Methodology**: This backtest trading mechanism is based upon the **Golden Cross** technical indicator(s). This trend exists under the following condition:

- For the Golden Cross to initiate, either of these two parameters must be true:

1. EMA.020 > EMA.050 &  
   EMA.050 > EMA.100 &  
   EMA.100 > EMA.200  
  or
2. SMA.020 > SMA.050 &  
   SMA.050 > SMA.100 &  
   SMA.100 > SMA.200

- Once all of either of these two conditions are met, a trading position is established the following day wherein:  
- 10,000 shares are purchased at the open price.
- The position is held until one of the conditions are false. Then the trade is closed the next day in the
  following manner.
- 10,000 shares are sold at the opening price.

**TRADE AT YOUR OWN RISK!!!** Any opinions, news, research, analyses, prices, or other information offered is provided as general market commentary, and does not constitute investment advice.  

Column {data-height=21%}
-------------------------------------

###

```{r 2.2.1.1-vbox-goldenx-trend-name}

flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("Golden Cross", toupper(str_sub(colnames(trendReturnsDaily[,as.numeric(input$radio2.2)]),-3, -1))),
    color = "rgb(214,173,74)",
    icon = 'fa-cross'
  )
})
```

###

```{r 2.2.1.2-vbox-goldenx-return-annual}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          Return.annualized(
            na.omit(
              trendReturnsDaily
                [,as.numeric(input$radio2.2)])
                [paste(format(input$dateRange2.2[1]),format(input$dateRange2.2[2]),sep = "::")]
          )
        )
      ), "", " Annual Return"
    ),
      color = ifelse(Return.annualized(
          na.omit(
            trendReturnsDaily
              [,as.numeric(input$radio2.2)])
              [paste(format(input$dateRange2.2[1]),format(input$dateRange2.2[2]),sep = "::")]) > 0,  
          "teal", "red"),
      icon = "ion-cash"
    )
  }
)
```

###

```{r 2.2.1.3-vbox-goldenx-returns-cumulative}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          as.numeric(
            Return.cumulative(
              na.omit(trendReturnsDaily
                [,as.numeric(input$radio2.2)])
                [paste(format(input$dateRange2.2[1][+1]), format(input$dateRange2.2[2]),sep = "::")]
                [-1,]
            )
          )
        )
      ), "", " Cumulative"
    ),
    color = ifelse(Return.cumulative(
        na.omit(
          trendReturnsDaily
            [,as.numeric(input$radio2.2)])
            [paste(format(input$dateRange2.2[1][+1]), format(input$dateRange2.2[2]),sep = "::")]) > 0,
      "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.2.1.4.a-vbox-goldenx-calendar-days, eval=trend}

flexdashboard::renderValueBox({

  calendarDays <- format(input$dateRange2.2[2] - input$dateRange2.2[1], big.mark = ",")
  calendarDays <- substr(calendarDays, 1, nchar(calendarDays) - 5)

  flexdashboard::valueBox(
    paste("Calendar Days: ", calendarDays)
  )
})
```

```{r 2.2.1.4.b-vbox-goldenx-trade-days}

flexdashboard::renderValueBox({
  tradeDays <- format(
      ndays(
        na.omit(
          trendReturnsDaily
            [,as.numeric(input$radio2.2)])
            [paste(format(input$dateRange2.2[1]), format(input$dateRange2.2[2]),sep = "::")]
        ),
      big.mark = ",")

  flexdashboard::valueBox(
    paste("Trade Days: ", "", tradeDays),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Column {data-height=50%, data-width=500 .tabset .tabset-fade}
-------------------------------------

### Golden Crossing Table

```{r 2.2.2.1-table-goldenx, eval=trend}

DT::renderDataTable({
    ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.2) - 2),]
    trendTable <- trend[indicator == ind]
    trendTable <- trendTable[catName == "GoldenX" &
                        (startDate >= input$dateRange2.2[1] &
                         endDate <= input$dateRange2.2[2])][,-c(9,13:16)]
    DT::datatable(trendTable,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr',
      order = list(list(5, "desc"), list(0, 'asc')),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatCurrency(c("startOpen", "endOpen")) %>%
    formatCurrency("Net.Trading.PL", digits = 0) %>%
    formatPercentage("return", 1) %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

### Price & Transactions Chart

```{r 2.2.2.2-viz-goldenx-posn-chartstats}

renderPlot(
  {
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.2) - 2),])
    blotter::getPortfolio(paste0("gX", ind), envir = .blotter)
    na.omit(quantmod::getSymbols("SPL.AX", src = 'FI', dir = ".", split_method = 'common', env = .blotter))
    blotter::chart.Posn(
      Portfolio = paste0("gX", ind),
      Symbol    = "SPL.AX",
      Dates     = paste(format(input$dateRange2.2[1]), format(input$dateRange2.2[2]),sep = "::"),
      env       = .blotter,
      TA        = "add_SMA(n = 20, col = 2); add_SMA(n = 50, col = 4)")
   }
)
```

### Maximum Adverse Excursion Chart

```{r 2.2.2.3-viz-goldenx-MAE}

renderPlot(
  {
    FinancialInstrument::currency(c("AUD", "USD"))           # Set the currency  ###
    FinancialInstrument::getInstrument("AUD","USD")
# ------------------------------------------------------------------------------
    FinancialInstrument::stock(c("SPL.AX"), currency ="AUD") # Define the stocks ###
    FinancialInstrument::getInstrument("SPL.AX")
# ------------------------------------------------------------------------------
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.2) - 2),])
    blotter::getPortfolio(paste0("gX", ind), envir = .blotter)
    blotter::chart.ME(
      Portfolio = paste0("gX", ind),
      Symbol    = "SPL.AX",
      type      =  "MAE"
      )
   }
)
```

### Maximum Favorable Excursion Chart

```{r 2.2.2.4-viz-goldenx-MFE}

renderPlot(
  {
    FinancialInstrument::currency(c("AUD", "USD"))           # Set the currency  ###
    FinancialInstrument::getInstrument("AUD","USD")
# ------------------------------------------------------------------------------
    FinancialInstrument::stock(c("SPL.AX"), currency ="AUD") # Define the stocks ###
    FinancialInstrument::getInstrument("SPL.AX")
# ------------------------------------------------------------------------------
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.2) - 2),])
    blotter::getPortfolio(paste0("gX", ind), envir = .blotter)
    blotter::chart.ME(
      Portfolio = paste0("gX", ind),
      Symbol    = "SPL.AX",
      type      =  "MFE"
      )
   }
)
```

Column {data-height=33%}
-------------------------------------

### GoldenX Return

```{r 2.2.3.1-viz-goldenx-roi-outliers}
xhpG <- list(title = g$catName, titlefont = F)
yhpG <- list(title = "Counts", titlefont = F)
ybpG <- list(title = g$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.2) - 2),]
  g <- g[indicator == ind]
  g <- g[(startDate >= input$dateRange2.2[1] &
          endDate   <= input$dateRange2.2[2])]

  histogramG <- plot_ly(g, x = g$return, type = "histogram", marker = list(color = "rgb(214,173,74)")) %>%
    layout(
      xaxis = xhpG
      ,yaxis = yhpG
      )

  boxplotG <- plot_ly(
              g
              ,x = g$return
              ,type = "box"
              ,boxpoints = "all"
              ,jitter = 0.3
              ,marker = list(
                color = "rgb(214,173,74)"
                ,outliercolor = "rgb(214,173,74)")
              ) %>%
              layout(
                yaxis = ybpG
              )
  boxplotG$data[[1]]$name <- 'Group A'

  # boxplotG$x$data[[1]]$name <- 'Group A'       https://is.gd/qChas5
  subplot(boxplotG, histogramG, nrows = 2, shareX = TRUE) %>%
    layout(
      xaxis = list(tickformat = "%")
      ,title = "ROI with Outliers"
      ,bargap = 0.1
      ,showlegend = FALSE)
})
```

### GoldenX Trade Days

```{r 2.2.3.2-viz-goldenx-trade-days}
xhpG <- list(title = g$catName, titlefont = F)
yhpG <- list(title = "Counts", titlefont = F)
ybpG <- list(title = g$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.2) - 2),]
  g <- g[indicator == ind]
  g <- g[(startDate >= input$dateRange2.2[1] &
          endDate   <= input$dateRange2.2[2])]

  histogramG <- plot_ly(g, x = g$tradeDays, type = "histogram", marker = list(color = "rgb(214,173,74)")) %>%
    layout(xaxis = xhpG, yaxis = yhpG)

  boxplotG <- plot_ly(g, x = g$tradeDays, type = "box", boxpoints = "all", jitter = 0.3, marker = list(color = "rgb(214,173,74)", outliercolor = "black")) %>%
    layout(yaxis = ybpG)
  subplot(boxplotG, histogramG, nrows = 2, shareX = TRUE) %>%
    layout(showlegend = FALSE) %>%
    layout(title = "# of Trade Days with Outliers", bargap = 0.1)
})
```

2.3 Death Cross {data-navmenu="2-Trends" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 2.3.0.1-sidebarInput}

dateRangeInput("dateRange2.3",
  "DeathX data",
  start = params$dateStart,
  end = Sys.Date()
)
```

```{r 2.3.0.2-sidebarRadio}
radioButtons("radio2.3", "Moving Avg:",
               c("Exponential" = 1,
                 "Simple" = 2)
)
```

_____________________________
**Trade Methodology**: This backtest trading mechanism is based upon the **Death Cross** technical indicator(s). This trend exists under the following condition:

- For the Death Cross to initiate, either of these two parameters must be true:

1. EMA.020 < EMA.050 &  
   EMA.050 < EMA.100 &  
   EMA.100 < EMA.200  
  or
2. SMA.020 < SMA.050 &  
   SMA.050 < SMA.100 &  
   SMA.100 < SMA.200

- Once all of either of these two conditions are met, a trading position is established the following day wherein:  
- 10,000 shares are sold short at the opening price.
- The position is held until one of the conditions are false. Then the trade is closed the following day wherein:
- 10,000 shares are purchased at the open price to close the position.

**TRADE AT YOUR OWN RISK!!!** Any opinions, news, research, analyses, prices, or other information offered is provided as general market commentary, and does not constitute investment advice.  

Row {data-height=21%}
-------------------------------------

###

```{r 2.3.1.1-vbox-trend-name}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("Death Cross", toupper(str_sub(colnames(trendReturnsDaily[,as.numeric(input$radio2.3)]),-3, -1))),
    color = 'black',
    icon = 'fa-cross'
  )
})
```

###

```{r 2.3.1.2-deathx-vbox-returns-annual}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          Return.annualized(
            na.omit(
              trendReturnsDaily[,as.numeric(
                input$radio2.3)])[paste(format(input$dateRange2.3[1]),
                  format(input$dateRange2.3[2]),sep = "::")]
          ) * -1
        )
      ), "", " Annual Return"
    ),
    color = ifelse(Return.annualized(
        na.omit(
          trendReturnsDaily[,as.numeric(
            input$radio2.3)])[paste(format(input$dateRange2.3[1]),
              format(input$dateRange2.3[2]),sep = "::")]) * -1 > 0,  
                "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.3.1.3-vbox-returns-cumulative}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          as.numeric(
            Return.cumulative(
              na.omit(trendReturnsDaily
                [,as.numeric(input$radio2.3)])
                [paste(format(input$dateRange2.3[1][+1]), format(input$dateRange2.3[2]),sep = "::")]
                [-1,]
            ) * -1
          )
        )
      ), "", " Cumulative"
    ),
    color = ifelse(Return.cumulative(
        na.omit(
          trendReturnsDaily
            [,as.numeric(input$radio2.3)])
            [paste(format(input$dateRange2.3[1][+1]), format(input$dateRange2.3[2]),sep = "::")]) * -1 > 0,  
      "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.3.1.4.a-vbox-deathx-calendar-days}

flexdashboard::renderValueBox({

  calendarDays <- format(input$dateRange2.3[2] - input$dateRange2.3[1], big.mark = ",")
  calendarDays <- substr(calendarDays, 1, nchar(calendarDays) - 5)

  flexdashboard::valueBox(
    paste("Calendar Days: ", calendarDays),
  )
})
```

```{r 2.3.1.4.b-vbox-trade-days}
flexdashboard::renderValueBox({
  tradeDays <- format(
    ndays(
      na.omit(
        trendReturnsDaily[,as.numeric(
          input$radio2.3)])[paste(format(input$dateRange2.3[1]),
            format(input$dateRange2.3[2]),sep = "::")]
         ),  
      big.mark = ",")

  flexdashboard::valueBox(
    paste("Trade Days: ", "", tradeDays),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Column {data-height=50%, data-width=500 .tabset .tabset-fade}
-------------------------------------

### DeathX Crossing Table

```{r 2.3.2.1-table-death, eval=trend}
DT::renderDataTable({
    ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.3)),]
    trendTable <- trend[indicator == ind]
    trendTable <- trendTable[catName == "DeathX" &
                        (startDate >= input$dateRange2.3[1] &
                         endDate <= input$dateRange2.3[2])][,-c(9,13:16)]
    DT::datatable(trendTable,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr',
      order = list(list(5, "desc"), list(0, 'asc')),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatCurrency(c("startOpen", "endOpen")) %>%
    formatCurrency("Net.Trading.PL", digits = 0) %>%
    formatPercentage("return", 1) %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

### Price & Transactions Chart

```{r 2.3.2.2-viz-deathX-posn-chartstats}

  renderPlot({
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.3) - 0),])
    blotter::getPortfolio(paste0("dX", ind), envir = .blotter)
    na.omit(getSymbols("SPL.AX", src = 'FI', dir = ".", split_method = 'common', env = .blotter))
    blotter::chart.Posn(paste0("dX", ind),
      Symbol = "SPL.AX",
      Dates  = paste(format(input$dateRange2.3[1]), format(input$dateRange2.3[2]),sep = "::"),
      env    = .blotter,
      TA     = "add_SMA(n = 20, col = 2); add_SMA(n = 50, col = 4)")
   })

```

### Maximum Adverse Excursion Chart

```{r 2.3.2.3-viz-deathx-MAE}

renderPlot(
  {
    FinancialInstrument::currency(c("AUD", "USD"))           # Set the currency  ###
    FinancialInstrument::getInstrument("AUD","USD")
# ------------------------------------------------------------------------------
    FinancialInstrument::stock(c("SPL.AX"), currency ="AUD") # Define the stocks ###
    FinancialInstrument::getInstrument("SPL.AX")
# ------------------------------------------------------------------------------
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.3) - 0),])
    blotter::getPortfolio(paste0("dX", ind), envir = .blotter)
    blotter::chart.ME(
      Portfolio = paste0("dX", ind),
      Symbol    = "SPL.AX",
      type      =  "MAE"
      )
   }
)
```

### Maximum Favorable Excursion Chart

```{r 2.3.2.4-viz-deathx-MFE}

renderPlot(
  {
    FinancialInstrument::currency(c("AUD", "USD"))           # Set the currency  ###
    FinancialInstrument::getInstrument("AUD","USD")
# ------------------------------------------------------------------------------
    FinancialInstrument::stock(c("SPL.AX"), currency ="AUD") # Define the stocks ###
    FinancialInstrument::getInstrument("SPL.AX")
# ------------------------------------------------------------------------------
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.3) - 0),])
    blotter::getPortfolio(paste0("dX", ind), envir = .blotter)
    blotter::chart.ME(
      Portfolio = paste0("dX", ind),
      Symbol    = "SPL.AX",
      type      =  "MFE"
      )
   }
)
```

Row {data-height=33%}
-------------------------------------

### DeathX Return

```{r 2.3.3.1-viz-deathx-roi-outliers}
xhpD <- list(title = d$catName, titlefont = F)
yhpD <- list(title = "Counts", titlefont = F)
ybpD <- list(title = d$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.3)),]
  d   <- d[indicator == ind]
  d   <- d[(startDate >= input$dateRange2.3[1] & endDate <= input$dateRange2.3[2])]

  histogramD <- plot_ly(d, x = d$return, type = "histogram", marker = list(color = "black")) %>%
    layout(xaxis = xhpD, yaxis = yhpD)
  boxplotD <- plot_ly(d, x = d$return, type = "box", boxpoints = "all", jitter = 0.3, marker =
    list(color = "black", outliercolor = "blue")) %>%
    layout(yaxis = ybpD)
  subplot(boxplotD, histogramD, nrows = 2, shareX = TRUE) %>%
    layout(
      xaxis = list(tickformat = "%")
      ,title = "ROI with Outliers"
      ,bargap = 0.1
      ,showlegend = FALSE)
})
```

### DeathX Trade Days

```{r 2.3.3.2-viz-deathx-trade-days}
xhp <- list(title = d$catName, titlefont = F)
yhp <- list(title = "Counts", titlefont = F)
ybp <- list(title = d$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.3)),]
  d <- d[indicator == ind]
  d <- d[(startDate >= input$dateRange2.3[1] &
          endDate   <= input$dateRange2.3[2])]

  histogramD <- plot_ly(d, x = d$tradeDays, type = "histogram", marker = list(color = "Black")) %>%
    layout(xaxis = xhp, yaxis = yhp)

  boxplotD <- plot_ly(d, x = d$tradeDays, type = "box", boxpoints = "all", jitter = 0.3, marker = list(color = "black", outliercolor = "#D0A92C", line = list(outliercolor = "#D0A92C", outlierwidth = 5))) %>%
    layout(yaxis = ybp)
  subplot(boxplotD, histogramD, nrows = 2, shareX = TRUE) %>%
    layout(showlegend = FALSE) %>%
    layout(title = "# of Trade Days with Outliers", bargap = 0.1)
})
```

2.4 No Cross {data-navmenu="2-Trends" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 2.4.0.1-sidebarInput}

dateRangeInput("dateRange2.4",
  "No Cross data",
  start = params$dateStart,
  end = Sys.Date()
)
```

```{r 2.4.0.2-sidebarRadio}
radioButtons("radio2.4", "Moving Avg:",
               c("Exponential" = 5,
                 "Simple" = 6)
)
```

_____________________________
**Trade Methodology**: In regard to the **No Cross** indicator, it transpires when neither the Golden Cross or Death Cross are active:

- In this case, a trade is established on the day either the Golden Cross or Death Cross have been closed thereby
- 10,000 shares are purchased at the open price.
- If either a Golden Cross or Death Cross is initiated , a trade is established on that day whereby
- 10,000 shares are sold at the opening price.

**TRADE AT YOUR OWN RISK!!!** Any opinions, news, research, analyses, prices, or other information offered is provided as general market commentary, and does not constitute investment advice.

Row {data-height=21%}
-------------------------------------

###

```{r 2.4.1.1-vbox-noX-trend-name}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
        paste("No Cross", toupper(str_sub(colnames(trendReturnsDaily[,as.numeric(input$radio2.4)]),-3, -1))),
          color = "#778899",
          icon = 'fa-cross'
  )
})
```

###

```{r 2.4.1.2-vbox-noX-returns-annual}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          Return.annualized(
            na.omit(
              trendReturnsDaily[,as.numeric(input$radio2.4)])[paste(format(input$dateRange2.4[1]),
                format(input$dateRange2.4[2]),sep = "::")]
          )
        )
      ), "", " Annual Return"
    ),
    color = ifelse(Return.annualized(
        na.omit(
          trendReturnsDaily[,as.numeric(input$radio2.4)])[paste(format(input$dateRange2.4[1]),
            format(input$dateRange2.4[2]),sep = "::")]) > 0,
              "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.4.1.3-vbox-noX-returns-cumulative}
cumReturn <- percent(as.numeric(Return.cumulative(trend[,9])))
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          as.numeric(
            Return.cumulative(
              na.omit(trendReturnsDaily[,as.numeric(input$radio2.4)])[paste(format(input$dateRange2.4[1]),
                format(input$dateRange2.4[2]),sep = "::")]
            )
          )
        )
      ), "", " Cumulative"
    ),
    color = ifelse(
      Return.cumulative(
        na.omit(
          trendReturnsDaily[,as.numeric(input$radio2.4)])[paste(format(input$dateRange2.4[1]),
            format(input$dateRange2.4[2]),sep = "::")]) > 0,
              "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.4.1.4.a-vbox-noX-calendar-days}

flexdashboard::renderValueBox({

  calendarDays <- format(input$dateRange2.4[2] - input$dateRange2.4[1], big.mark = ",")
  calendarDays <- substr(calendarDays, 1, nchar(calendarDays) - 5)

  flexdashboard::valueBox(
    paste("Calendar Days: ", calendarDays),
  )
})
```

```{r 2.4.1.4.b-vbox-noX-trade-days, eval=trend}

flexdashboard::renderValueBox({
  tradeDays <-   format(
    ndays(
      na.omit(
        trendReturnsDaily[,as.numeric(input$radio2.4)])[paste(format(input$dateRange2.4[1]),
          format(input$dateRange2.4[2]),sep = "::")]
    ),
  big.mark = ",")

  flexdashboard::valueBox(
    paste("Trade Days: ", "", tradeDays),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Column {data-height=50%, data-width=500 .tabset .tabset-fade}
-------------------------------------

### NoX Crossing Table

```{r 2.4.2.1-table-noX, eval=trend}
DT::renderDataTable({
    ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.4) - 4),]
    trendTable <- trend[indicator == ind]
    trendTable <- trendTable[catName == "NoX" &
                        (startDate >= input$dateRange2.4[1] &
                         endDate <= input$dateRange2.4[2])][,-c(9,13:16)]
    DT::datatable(trendTable,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr',
      order = list(list(5, "desc"), list(0, 'asc')),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatCurrency(c("startOpen", "endOpen")) %>%
    formatCurrency("Net.Trading.PL", digits = 0) %>%
    formatPercentage("return", 1) %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

### Price & Transactions Chart

```{r 2.4.2.2-viz-nox-posn-chartstats}

  renderPlot({
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.4) - 4),])
    blotter::getPortfolio(paste0("nX", ind), envir = .blotter)
    na.omit(getSymbols("SPL.AX", src = 'RData', dir = ".", split_method = 'common', env = .blotter))
    blotter::chart.Posn(paste0("nX", ind),
     Symbol = "SPL.AX",
     Dates  = paste(format(input$dateRange2.4[1]), format(input$dateRange2.4[2]),sep = "::"),
     env    = .blotter,
     TA     = "add_SMA(n = 20, col = 2); add_SMA(n = 50, col = 4)")
  })

```

### Maximum Adverse Excursion Chart

```{r 2.4.2.3-viz-deathx-MAE}

renderPlot(
  {
# ------------------------------------------------------------------------------    
    FinancialInstrument::currency(c("AUD", "USD"))           # Set the currency  ###
    FinancialInstrument::getInstrument("AUD","USD")
# ------------------------------------------------------------------------------
    FinancialInstrument::stock(c("SPL.AX"), currency ="AUD") # Define the stocks ###
    FinancialInstrument::getInstrument("SPL.AX")
# ------------------------------------------------------------------------------
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.4) - 4),])
    blotter::getPortfolio(paste0("nX", ind), envir = .blotter)
    blotter::chart.ME(
      Portfolio = paste0("nX", ind),
      Symbol    = "SPL.AX",
      type      =  "MAE"
      )
   }
)
```

### Maximum Favorable Excursion Chart

```{r 2.4.2.4-viz-deathx-MFE}

renderPlot(
  {
# ------------------------------------------------------------------------------    
    FinancialInstrument::currency(c("AUD", "USD"))           # Set the currency  ###
    FinancialInstrument::getInstrument("AUD","USD")
# ------------------------------------------------------------------------------
    FinancialInstrument::stock(c("SPL.AX"), currency ="AUD") # Define the stocks ###
    FinancialInstrument::getInstrument("SPL.AX")
# ------------------------------------------------------------------------------
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.4) - 4),])
    blotter::getPortfolio(paste0("nX", ind), envir = .blotter)
    blotter::chart.ME(
      Portfolio = paste0("nX", ind),
      Symbol    = "SPL.AX",
      type      =  "MFE"
      )
   }
)
```

Row {data-height=33%}
-------------------------------------

### No X Return

```{r 2.4.3.1-viz-noX-roi-outliers, eval=trend}
xhp <- list(title = n$catName, titlefont = F)
yhp <- list(title = "Counts", titlefont = F)
ybp <- list(title = n$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.4) - 4),]
  n   <- n[indicator == ind]
  n   <- n[(startDate >= input$dateRange2.4[1] & endDate <= input$dateRange2.4[2])]

  histogram <-
    plot_ly(n,
            x = n$return,
            type = "histogram",
            marker = list(
              color = "#778899")) %>%
            layout(xaxis = xhp,
                   yaxis = yhp)
  boxplot <-
    plot_ly(n,
            x = n$return,
            type = "box",
            boxpoints = "all",
            jitter = 0.3,
            marker = list(
              color = "steel blue")) %>%
            layout(yaxis = ybp)
            subplot(boxplot,
                    histogram,
                    nrows = 2,
                    shareX = TRUE) %>%
            layout(
              xaxis = list(
                tickformat = "%")
                ,title = "ROI with Outliers"
                ,bargap = 0.1
                ,showlegend = FALSE)
})
```

### No X Trade Days

```{r 2.4.3.2-viz-noX-trade-days}

xhp <- list(title = n$catName, titlefont = F)
yhp <- list(title = "Counts", titlefont = F)
ybp <- list(title = n$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.4) - 4),]
  n <- n[indicator == ind]
  n <- n[(startDate >= input$dateRange2.4[1] &
          endDate   <= input$dateRange2.4[2])]

  histogramN <-
    plot_ly(n,
            x = n$tradeDays,
            type = "histogram",
            marker = list(
              color = "#778899",
              outliercolor = "#778899")) %>%
            layout(xaxis = xhp,
                   yaxis = yhp)

  boxplotN <-
    plot_ly(n,
            x = n$tradeDays,
            type = "box",
            boxpoints = "all",
            jitter = 0.3,
            marker = list(
              color = "steel blue",
              line = list(
                outliercolor = "#D0A92C",
                outlierwidth = 5))
            ) %>%
            layout(yaxis = ybp)
            subplot(boxplotN,
                    histogramN,
                    nrows = 2,
                    shareX = TRUE) %>%
            layout(showlegend = FALSE) %>%
            layout(title = "# of Trade Days with Outliers", bargap = 0.1)
})
```

3.1 Dispersion {data-navmenu="3-Technical Analysis" data-icon="fa-list"}
=====================================

Input {.sidebar}
-------------------------------------

```{r 3.0.0.1-sidebarInput}
dateRangeInput("dateRange3.0",
  "Dispersion data",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```

Column {data-height=21%}
-------------------------------------

###

```{r 3.1.1.1.a-vbox-disp-last}

flexdashboard::renderValueBox({
  disp_last <-  percent(
                  max(
                    xts::last(
                      na.omit(                  
                        xts_bb20_disp[,5]
                      )
                    )
                  )
                )
# ------------------------------------------------------------------------------
  flexdashboard::valueBox(
    paste0("Disp: ", as.character(disp_last)),
    color = ifelse(disp_last > 0, "#BF5700", "red"),
    icon  = "ion-cash"
  )
})

```

```{r 3.1.1.1.b-vbox-disp-delta}

flexdashboard::renderValueBox({
  delt_last <-  percent(
                  max(
                    xts::last(
                      na.omit(                  
                        xts_bb20_disp[,6]
                      )
                    )
                  )
                )
# ------------------------------------------------------------------------------
  flexdashboard::valueBox(
    paste0("Delta: ", as.character(delt_last)),
    color = ifelse(delt_last > 0, "#BF5700", "red"),
    icon  = "ion-cash"
  )
})

```

###

```{r 3.1.1.2.a-vbox-max-disp}

flexdashboard::renderValueBox({
  disp_max <- percent(
                max(
                  na.omit(                  
                    xts_bb20_disp[paste(format(input$dateRange3.0[1][+1]), format(input$dateRange3.0[2]),sep = "::")][,5]
                    )
                  )
                )
# ------------------------------------------------------------------------------
  flexdashboard::valueBox(
    paste0("Max Disp: ", as.character(disp_max)),
    color = ifelse(disp_max > 0, "teal", "red"),
    icon  = "ion-cash"
  )
})
```

```{r 3.1.1.2.b-vbox-max-delt}

flexdashboard::renderValueBox({
  delt_max <- percent(
                max(
                  na.omit(                  
                    xts_bb20_disp[paste(format(input$dateRange3.0[1][+1]), format(input$dateRange3.0[2]),sep = "::")][,6]
                    )
                  )
                )
# ------------------------------------------------------------------------------
  flexdashboard::valueBox(
    paste0("Max Delta: ", as.character(delt_max)),
    color = fcase(
      delt_max > 0, "teal", 
      delt_max < 0, "red", 
      default  = "gray30"),
    icon  = "ion-cash"
  )
})

```

###

```{r 3.1.1.3.a-vbox-min-disp}

flexdashboard::renderValueBox({
  disp_min <- percent(
                min(
                  na.omit(                  
                    xts_bb20_disp[paste(format(input$dateRange3.0[1][+1]), format(input$dateRange3.0[2]),sep = "::")][,5]
                    )
                  )
                )
# ------------------------------------------------------------------------------
  flexdashboard::valueBox(
    paste0("Min Disp: ", as.character(disp_min)),
    color = ifelse(disp_min > 0, "teal", "red"),
    icon  = "ion-cash"
  )
})

```

```{r 3.1.1.3.b-vbox-min-delt}

flexdashboard::renderValueBox({
  delt_min <- percent(
                min(
                  na.omit(                  
                    xts_bb20_disp[paste(format(input$dateRange3.0[1][+1]), format(input$dateRange3.0[2]),sep = "::")][,6]
                    )
                  )
                )
# ------------------------------------------------------------------------------
  flexdashboard::valueBox(
    paste0("Min Delta: ", as.character(delt_min)),
    color = ifelse(delt_min > 0, "teal", "red"),
    icon  = "ion-cash"
  )
})

```

###

```{r 3.1.1.4.a-vbox--med-disp}

flexdashboard::renderValueBox({
  disp_med <- percent(
                median.zoo(
                  na.omit(
                    xts_bb20_disp[paste(format(input$dateRange3.0[1][+1]), format(input$dateRange3.0[2]),sep = "::")][,5]
                    )
                  )
                )
# ------------------------------------------------------------------------------
  flexdashboard::valueBox(
    paste0("Med Disp: ", as.character(disp_med)),
    color = ifelse(disp_med > 0, "teal", "red"),
    icon  = "ion-cash"
  )
})

```

```{r 3.1.1.4.b-vbox-med-delt}

flexdashboard::renderValueBox({
  delt_med <- percent(
                median.zoo(
                  na.omit(
                    xts_bb20_disp[paste(format(input$dateRange3.0[1][+1]), format(input$dateRange3.0[2]),sep = "::")][,6]
                    )
                  )
                )
# ------------------------------------------------------------------------------
  flexdashboard::valueBox(
    paste0("Med Delta: ", as.character(delt_med)),
    color = ifelse(delt_med > 0, "teal", "red"),
    icon  = "ion-cash"
  )
})

```

###

```{r 3.1.1.5.a-vbox-noX-calendar-days}

flexdashboard::renderValueBox({

  calendarDays <- format(input$dateRange3.0[2] - input$dateRange3.0[1], big.mark = ",")
  calendarDays <- substr(calendarDays, 1, nchar(calendarDays) - 5)
# ------------------------------------------------------------------------------
  flexdashboard::valueBox(
    paste("Cal Days: ", calendarDays),
  )
})
```

```{r 3.1.1.5.b-vbox-noX-trade-days, eval=trend}

flexdashboard::renderValueBox({
  tradeDays <-   format(
    ndays(
      na.omit(
        trendReturnsDaily[,as.numeric(input$radio2.4)])[paste(format(input$dateRange3.0[1]),
          format(input$dateRange3.0[2]),sep = "::")]
    ),
  big.mark = ",")
# ------------------------------------------------------------------------------
  flexdashboard::valueBox(
    paste("Trade Days: ", "", tradeDays),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Column {data-height=50%, data-width=500 .tabset .tabset-fade}
-------------------------------------

### Dispersion Table

```{r 3.1.2.1-table-disp}

DT::renderDataTable({
    dt_disp <-  na.omit(
                  data.table(
                    merge(SPL.AX[,4:5], dt_bb20_disp)
                    [paste(format(input$dateRange3.0[1][+1]), format(input$dateRange3.0[2]),sep = "::")],
                  keep.rownames = TRUE)
                )

    DT::datatable(dt_disp,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr',
      order = list(list(0, "desc")),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatDate(c("index")) %>%
    formatCurrency("SPL.AX.Close", digits = 2) %>%
    formatRound("SPL.AX.Volume", mark = ",", digits = 0) %>%
    formatPercentage(c("dn", "mavg", "up", "pctB", "pct", "delta"), 1) %>%
    formatStyle("pct",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("delta",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```


### Bollinger Band Dispersion

```{r 3.1.2.2-viz-bollinger-band-disp, eval=dt_bb20_disp}

renderPlotly({
  xts_bb20_disp
  ggplotly(data.table(
    xts_bb20_disp
    [paste(format(input$dateRange3.0[1][+1]), format(input$dateRange3.0[2]), sep = "::")],
    keep.rownames = TRUE
  )
  %>%
    plot_time_series(
      .date_var = index,
      .value = pct,
      .smooth = TRUE,
      .interactive = FALSE
    ) +
    theme_cyberpunk() +
    geom_line(size = 0.5, colour = "#bf5700"))
})
```

### Bollinger Band Dispersion Delta

```{r 3.1.2.3-viz-bollinger-band-disp-delta, eval=dt_bb20_disp}

renderPlotly({
  xts_bb20_disp
  ggplotly(data.table(
    xts_bb20_disp
    [paste(format(input$dateRange3.0[1][+1]), format(input$dateRange3.0[2]), sep = "::")],
    keep.rownames = TRUE
  )
  %>%
    plot_time_series(
      .date_var = index,
      .value = delta,
      .smooth = TRUE,
      .interactive = FALSE
    ) +
    theme_cyberpunk() +
    geom_line(size = 0.5, colour = "#0c4c8a"))
})
```


Row {data-height=33%}
-------------------------------------

### Chaikan Money Flow

```{r 3.1.3.3-viz-chaikan-money-flow, eval=price}

renderPlot({
  x <- tk_xts(price())
  chartSeries(x,
    theme = "black",
    subset = paste(format(input$dateRange3.0[1][+1]), format(input$dateRange3.0[2]), sep = "::"),
    TA = "addBBands();addVo();addCMF();addZLEMA()"
  )
})

```
