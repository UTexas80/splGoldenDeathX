---
title: "SPL Dashboard"
output:
  flexdashboard::flex_dashboard:
    orientation: row
    source_code: embed
    vertical_layout: fill
date: "`r params$reportdate`"
resource_files:
- rdata/gXema.RData
- rds/dtEMA.rds
- rds/dt_trade_stats.rds
- rds/golden.rds
- rds/goldenX_EMA.RData
- rds/goldenX_EMA_strategy.RData
- rds/tradeDays.rds
- rds/trend.rds
- rds/trendSummaryGroup.rds
- rds/trendReturns.rds
- rds/trendReturnsSMA.rds
- rds/trend.rds
- rds/trendReturnsAnnualized.rds
- rdata/buyhold_strat.RData
- rds/calendarDays.rds
- rds/dt_trade_stats.rds
- rds/dtEMA.rds
- rds/golden.rds
- rds/dXema_trade_stats.rds
- rds/dXsma_trade_stats.rds
- rds/gXema_trade_stats.rds
- rds/gXsma_trade_stats.rds
- dXsma_port_rdata.RData
- rds/dXema.rds
- gXema.RData
- SPL.AX/SPL.AX.rda
runtime: shiny
theme: spacelab
params:
  dateEnd: !r Sys.Date()
  dateStart: '2002-01-02'
  dynamictitle: My report
  reportDate:
    input: date
    label: 'Report Date:'
    value: as.POSIXct(Sys.Date())
  symbols: SPL.AX
  ticker: SPL.AX
---

```{r global, echo=FALSE, include=FALSE, message = FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
knitr::opts_knit$set(root.dir = "..", echo = FALSE)
# library(d3heatmap)
library(blotter)
library(data.table)
library(dplyr)
library(DT)
library(dygraphs)
library(FinancialInstrument)
library(flexdashboard)
library(formattable)
library(ggplot2)
library(grid)
library(gridExtra)
library(gt)
library(here)
library(highcharter)
library(hydroTSM)
library(knitr)
library(kableExtra)
library(lubridate)
library(magrittr)
library(PerformanceAnalytics)
library(plotly)
library(quantmod)
library(quantstrat)
library(readr)
library(rmarkdown)
library(scales)
library(shiny)
# library(shinybusy)
library(shinydashboard)
library(shinyWidgets)
# library(tidyquant)
library(stringr)
library(tidyverse)
library(timetk)
library(treemap)
library(utils)
library(xts)
library(zoo)
```

```{r functions}

# A function to build an xts object to hold both ticker returns.
# Function to calculate monthly returns on a stock
monthly_stock_returns <- function(ticker, dateStart) {

  # Download the data from Yahoo finance
  symbol <- getSymbols("SPL.AX",
    src = "yahoo", from = "2019-07-02",
    auto.assign = FALSE, warnings = FALSE
  )

  # Transform it to monthly returns using the periodReturn function from quantmod
  data <- periodReturn("SPL.AX", period = "monthly", type = "log")

  # Let's rename the column of returns to something intuitive because the column
  # name is what will eventually be displayed on the time series graph
  colnames(data) <- as.character("SPL.AX")

  # We want to be able to work with the xts objects that result from this function
  # so let's explicitly put them to the global environment with an easy to use
  # name, the stock ticker
  assign("SPL_returns", data, .GlobalEnv)
} # monthly_stock_returns


# xts_price <- tk_xts(price())
# xts_ma <- tk_xts(ma_SPL)
# merge(xts_price,xts_ma, join='inner')[,c(6:10)]
# xts.obj[paste(start.date,end.date,sep="::")]
# merge(xts_price, xts_ma, join = 'inner')[,c(6:10)][paste(format(input$dateRange[1]),format(input$dateRange[2]),sep="::")]

xprices <- function() {
  symbols <- ("SPL.AX")

  tidyquant::tq_get(symbols,
    get = "stock.prices",
    from = input$dateRange[1],
    to = input$dateRange[2]
  )
}

```

```{r rdsInput}
# buyHold_results         <- readRDS(here::here("rds", "buyHold_results.rds"))
calendarDays              <- readRDS(here::here("rds", "calendarDays.rds"))
dtEMA                     <- readRDS(here::here("rds", "dtEMA.rds"))
golden                    <- readRDS(here::here("rds", "golden.rds"))
# ------------------------------------------------------------------------------
dt_trade_stats            <- readRDS(here::here("rds", "dt_trade_stats.rds"))
# ------------------------------------------------------------------------------
dXema_trade_stats         <- readRDS(here::here("rds", "dXema_trade_stats.rds"))
dXsma_trade_stats         <- readRDS(here::here("rds", "dXsma_trade_stats.rds"))
gXema_trade_stats         <- readRDS(here::here("rds", "gXema_trade_stats.rds"))
gXsma_trade_stats         <- readRDS(here::here("rds", "gXsma_trade_stats.rds"))
# ------------------------------------------------------------------------------This is what feeds log.chart.Posn
SPL.AX                    <- na.omit(as.xts(readRDS(here::here("rds", "SPL.AX.rds"))),keep.rownames = TRUE)
# ------------------------------------------------------------------------------
tradeDays                 <- readRDS(here::here("rds", "tradeDays.rds"))
trend                     <- data.table(readRDS(here::here("rds", "trend.rds")))
# trendClose                <- readRDS(here::here("rds", "trendClose.rds"))
trendDraw                 <- data.table(readRDS(here::here("rds", "trendDraw.rds")))
# trendEMA                  <- data.table(readRDS(here::here("rds", "trendEMA.rds")))
trendReturns              <- data.table(readRDS(here::here("rds", "trendReturns.rds")))
trendReturnsAnnualized    <- data.table(readRDS(here::here("rds", "trendReturnsAnnualized.rds")))
trendReturnsDaily         <- readRDS(here::here("rds", "trendReturnsDaily.rds"))
trendReturnsEMAlong       <- data.table(readRDS(here::here("rds", "trendReturnsEMAlong.rds")))
trendReturnsSMA           <- data.table(readRDS(here::here("rds", "trendReturnsSMA.rds")))
trendReturnsSMAlong       <- data.table(readRDS(here::here("rds", "trendReturnsSMAlong.rds")))
# trendSMA                  <- data.table(readRDS(here::here("rds", "trendSMA.rds")))
# trendSummary            <- data.table(readRDS(here::here("rds", "trendSummary.rds")))
# ------------------------------------------------------------------------------
emaPct                    <- data.table(readRDS(here::here("rds", "emaPct.rds")))
smaPct                    <- data.table(readRDS(here::here("rds", "smaPct.rds")))  
trendSummaryGroup         <- data.table(readRDS(here::here("rds", "trendSummaryGroup.rds")))
# ------------------------------------------------------------------------------
xtsEMA                    <- as.xts(readRDS(here::here("rds", "xtsEMA.rds")))
```

```{r blotter-rds}
# ------------------------------------------------------------------------------
dXema                     <- readRDS(here::here("rds", "dXema.rds"))
dXsma                     <- readRDS(here::here("rds", "dXsma.rds"))
# ------------------------------------------------------------------------------
gXema                     <- readRDS(here::here("rds", "gXema.rds"))
gXsma                     <- readRDS(here::here("rds", "gXsma.rds"))
# ------------------------------------------------------------------------------
nXema                     <- readRDS(here::here("rds", "nXema.rds"))
nXsma                     <- readRDS(here::here("rds", "nXsma.rds"))
# ------------------------------------------------------------------------------
```

```{r blotter-accounts}
# ------------------------------------------------------------------------------
dXema                     <- blotter::put.account  ("dXema", dXema, envir = .blotter)
dXsma                     <- blotter::put.account  ("dXsma", dXsma, envir = .blotter)
# ------------------------------------------------------------------------------
gXema                     <- blotter::put.account  ("gXema", gXema, envir = .blotter)
gXsma                     <- blotter::put.account  ("gXsma", gXsma, envir = .blotter)
# ------------------------------------------------------------------------------
nXema                     <- blotter::put.account  ("nXema", nXema, envir = .blotter)
nXsma                     <- blotter::put.account  ("nXsma", nXsma, envir = .blotter)
# ------------------------------------------------------------------------------
```

```{r blotter-portfoliios}
# ------------------------------------------------------------------------------
dXema                     <- blotter::put.portfolio("dXema", dXema, envir = .blotter)
dXsma                     <- blotter::put.portfolio("dXsma", dXsma, envir = .blotter)
# ------------------------------------------------------------------------------
gXema                     <- blotter::put.portfolio("gXema", gXema, envir = .blotter)
gXsma                     <- blotter::put.portfolio("gXsma", gXsma, envir = .blotter)
# ------------------------------------------------------------------------------
nXema                     <- blotter::put.portfolio("nXema", nXema, envir = .blotter)
nXsma                     <- blotter::put.portfolio("nXsma", nXsma, envir = .blotter)
# ------------------------------------------------------------------------------
```

```{r processing}
trendname    <- str_sub(tail(trend[indicator=='SMA'][order(endDate)], 1)[, 1], end = -4)
trendname1   <- substr(tail(trend[order(endDate)], 1)[, 1], 1, 1)
# subset trend
d <- trend[substr(trend$catName, 1, 1) %like% "D"]
dEMA <- d[indicator == 'EMA']
dSMA <- d[indicator == 'SMA']
g <- trend[substr(trend$catName, 1, 1) %like% "G"]
n <- trend[substr(trend$catName, 1, 1) %like% "N"]
```

```{r quantstrat-environment}
# ------------------------------------------------------------------------------
if(!exists(".blotter"))    .blotter    <<- new.env()
if(!exists(".instrument")) .instrument <<- new.env()
if(!exists(".portfolio"))  .portfolio  <<- new.env()
if(!exists(".strategy"))   .strategy   <<- new.env()
# ------------------------------------------------------------------------------
```

```{r quantstrat-input}
# ------------------------------------------------------------------------------
Sys.setenv(TZ = 'America/New_York')
# ------------------------------------------------------------------------------
curr     <- FinancialInstrument::currency("USD")
get_curr <- FinancialInstrument::getInstrument("USD")
# ------------------------------------------------------------------------------
stk      <- FinancialInstrument::stock("SPL.AX", "USD")
SPL.AX   <- FinancialInstrument::getInstrument("SPL.AX")
SPL.AX   <- get("SPL.AX", envir  = FinancialInstrument:::.instrument)
# ------------------------------------------------------------------------------
```

```{R daydiff functions, include=FALSE, warning=FALSE, cache=FALSE}

dayDifff <- function(X)
{
    as.numeric(as.Date(index(X))) - c(NA, as.numeric(as.Date(index(X[-nrow(X)]))))
}
```

1.1 Summary {data-navmenu="1-Performance" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 1.0.0.1-sidebarInput}
dateRangeInput("dateRange",
  "Historical data",
  start = params$dateStart,
  end = Sys.Date(),
  min = params$dateStart,
  max = Sys.Date()
)
```
Welcome to the SPL Golden Crossing Dashboard!

Mission: utilize Machine Learning & Fintech analytics to vette the ASX for compelling Small Cap Biotech risk adverse trading opportunities.

Objective: The purpose of this dashboard is twofold.

1. To provide a glimpse of Starpharma's performance circa 2002-01-02.
2. To examine the Golden Cross, Death Cross and No Cross Trading Strategies to discern their viability.

This site is developed using a reactive framework thereby allowing a dynamic interaction with any of the input variables. Therefore, whenever the date is updated the corresponding entries will be dynamically updated as well.

As a side note, to formulate the Crossing Trading Systems, the annualized return and ROI formulas are based upon the 20, 50, 100- and 200-day moving averages. Hence any dates selected with a start date less than 200 trading days prior to today, i.e., in the range from  `` `r head(tail(index(xtsEMA),200),1)` `` to `` `r Sys.Date()` `` will generate an error. I am currently working on a solution.

If you have any questions, or would like to provide feedback please: [email me](mailto:utexas80@gmail.com)

Thank you for your time and consideration. I hope that you enjoy the site.

RISKS ASSOCIATED WITH TRADING THE STOCK MARKET

All investments involve risk, and the past performance of a security, industry, sector, market, financial product, trading strategy, or individual’s trading does not guarantee future results or returns. Investors are fully responsible for any investment decisions they make. Such decisions should be based solely on an evaluation of their financial circumstances, investment objectives, risk tolerance, and liquidity needs.

Any opinions, news, research, analyses, prices, or other information offered is provided as general market commentary, and does not constitute investment advice. I will not accept liability for any loss or damage, including without limitation any loss of profit, which may arise directly or indirectly from use of or reliance on such information.

```{r 1.0.0.1-sidebar-ActionGo}

tqPrices <- eventReactive(input$go, {
  tqPrices <- tidyquant::tq_get("SPL.AX",
    get = "stock.prices",
    from = format(input$dateRange[1]),
    to = format(input$dateRange[2])
  )
})

#  date        open  high   low close volume adjusted   change
price <- reactive({
  tidyquant::tq_get("SPL.AX",
    from = format(input$dateRange[1]),
    to = format(input$dateRange[2])) %>%
    mutate(
      change = close - open,
      ema020 = EMA(na.fill0(close, 0), 20),
      ema050 = EMA(na.fill0(close, 0), 50),
      ema100 = EMA(na.fill0(close, 0), 100),
      ema200 = EMA(na.fill0(close, 0), 200),
      sma020 = SMA(na.fill0(close, 0), 20),
      sma050 = SMA(na.fill0(close, 0), 50),
      sma100 = SMA(na.fill0(close, 0), 100),
      sma200 = SMA(na.fill0(close, 0), 200)
    )
})
```

Column {data-height=60}
-------------------------------------

###

```{r 1.1.1.1-vbox-calendar-days}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())

  calendarDays <- format(end(xts_price) - start(xts_price), big.mark = ",")
  calendarDays <- substr(calendarDays, 1, nchar(calendarDays) - 5)

  flexdashboard::valueBox(
    paste(calendarDays, "", " Calendar Days"),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

###

```{r 1.1.1.2-vbox-returns-annualized}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  annReturn <- percent((as.numeric(last(xts_price[, 4])) / as.numeric(first(xts_price[, 4])))^((1 / nyears(xts_price))) - 1)

  flexdashboard::valueBox(
    paste(as.character(annReturn), "", " Annualized Return"),
    color = ifelse(annReturn > 0, "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 1.1.1.3-vbox-returns-cumulative}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  cumReturn <- percent((as.numeric(last(xts_price[, 4])) - as.numeric(first(xts_price[, 4]))) / (as.numeric(first(xts_price[, 4]))))

  flexdashboard::valueBox(
    paste(as.character(cumReturn), "", " ROI"),
    color = ifelse(cumReturn > 0, "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 1.1.1.4-vbox-trade-days}

flexdashboard::renderValueBox({
  xts_price <- tk_xts(price())
  tradeDays <- format(ndays(xts_price), big.mark = ",")

  flexdashboard::valueBox(
    paste(tradeDays, "", " Trade Days"),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Row {data-height=200}
-------------------------------------

### Stock Price Table

```{r 1.1.2.1-table-Price}
DT::renderDataTable({
  DT::datatable(price()[,-c(1,8:9)],
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr'
      ,order = list(list(0, "desc"))
      ,pageLength = 20
      ,scrollX = TRUE
      ,scrollY = 280
      ,scroller = TRUE)
    ) %>%
    formatCurrency(c(
      "open", "high", "low", "close",
      "ema020", "ema050", "ema100", "ema200", "sma020", "sma050", "sma100", "sma200"
    )) %>%
    formatCurrency('volume', currency = "", interval = 3, mark = ",", digits=0)  %>%
    formatDate(c("date")) %>%
    formatStyle("volume",
      background = styleColorBar(price()$volume, "steelblue")
    )
})
```

Row {data-height=200}
-------------------------------------

### Stock Price Over Time (Chart)
```{r  1.1.2.2-viz-Price, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  colnames(xts_price) <- paste0(input$ticker, ".", colnames(xts_price))
  highchart(type = "stock") %>%
    hc_add_series(xts_price, type = "candlestick")
})
```

### Distribution

```{r 1.1.2.3-viz-histogram, eval=price}

# draw a histogram
renderPlot({

  # generate bins based on input$bins from ui.R
  x <- tk_xts(price())
  hist(x[, 6],
    main = "Closing Price",
    xlab = "price",
    ylab = "Count",
    col = "darkmagenta",
    freq = TRUE,
    border = "white",
    xlim = c(0.0, 2),
    seq(0.1, 2, by = 0.10)
  )
})
```

1.2 Returns {data-navmenu="1-Performance" data-icon="ion-cash"}
=====================================

Column {data-width=500 .tabset .tabset-fade}
-------------------------------------

### Daily Returns

```{r 1.2.1.a-viz-ret-Daily, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  dailyRet <- periodReturn(xts_price[, 6], period = "daily") * 100
  highchart(type = "stock") %>%
    hc_add_series(dailyRet, type = "column")
})
```

### Weekly Returns

```{r 1.2.1.b-viz-ret-Weekly, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  weeklyRet <- periodReturn(xts_price[, 6], period = "weekly") * 100
  highchart(type = "stock") %>%
    hc_add_series(weeklyRet, type = "column")
})
```

### Monthly Returns

```{r 1.2.1.c-viz-ret-monthly, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  monthlyRet <- periodReturn(xts_price[, 6], period = "monthly") * 100
  highchart(type = "stock") %>%
    hc_add_series(monthlyRet, type = "column")
})
```

### Quarterly Returns

```{r 1.2.1.d-viz-ret-quarterly, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  quarterlyRet <- periodReturn(xts_price[, 6], period = "quarterly") * 100
  highchart(type = "stock") %>%
    hc_add_series(quarterlyRet, type = "column")
})
```

### Annual Returns

```{r 1.2.1.e-viz-ret-annual, eval=price}
renderHighchart({
  xts_price <- tk_xts(price())
  annualRet <- periodReturn(xts_price[, 6], period = "yearly") * 100
  highchart(type = "stock") %>%
    hc_add_series(annualRet, type = "column")
})
```

### $1 Invested

```{r 1.2.1.f-viz-ret-future, eval=price}

renderHighchart({
  xts_price <- tk_xts(price())
  dailyRet <- periodReturn(xts_price[, 6], period = "daily")
  dailyRet[dailyRet == 0] <- NA
  dailyRet <- 1 + dailyRet
  fv <- cumprod(na.omit(dailyRet))
  highchart(type = "stock") %>%
    hc_add_series(fv, type = "line") %>%
    hc_add_theme(hc_theme_darkunica()) %>%
    hc_yAxis(
      title = list(text = "$1"),
      opposite = TRUE,
      plotLines = list(
        list(
          label = list(text = "This is a plotLine"),
          color = "blue",
          width = 3,
          value = 1.0
        )
      )
    )
})
```

2.1 Summary {data-navmenu="2-Trends" data-icon="fa-list"}
=====================================

Column {data-height=21%}
-------------------------------------
###

```{r 2.1.0.1a-vbox-trendName, eval=trend}

# https://is.gd/vb865W In flexdashboard, can a valueBox be clicked to update a text box like an actionButton?

trendnameEMA    <- tail(trend[indicator == 'EMA'][order(endDate)], 1)[, 2]
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("EMA Current Trend:", " ", trendnameEMA),
    actionButton("button3", " ",
    style = "background-color:rgba(0, 0, 0, 0.0);
      border-color:rgba(0, 0, 0, 0.0);
      position: absolute;
      overflow: hidden;
      left: 0px;
      top: 0px;
      right: 0px;
      bottom: 0px;
      width:100%"),
    color = ifelse(trendname1 == "D", "black",
      ifelse(trendname1 == "G", "teal",
        "purple"
      )
    ),
    icon = ifelse(trendname1 == "D", "fa-thumbs-down",
      ifelse(trendname1 == "G", "fa-thumbs-up",
        ifelse(trendname1 == "n" & trend$return > 0,
          "fa-thumbs-up",
          "fa-thumbs-down"
        )
      )
    )
  )
})
```
```{r 2.1.0.1b-vbox-trend, eval=trend}

# https://is.gd/vb865W In flexdashboard, can a valueBox be clicked to update a text box like an actionButton?

trendnameSMA    <- tail(trend[indicator == 'SMA'][order(endDate)], 1)[, 2]
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("SMA Current Trend:", " ", trendnameSMA),
    actionButton("button3", " ",
    style = "background-color:rgba(0, 0, 0, 0.0);
      border-color:rgba(0, 0, 0, 0.0);
      position: absolute;
      overflow: hidden;
      left: 0px;
      top: 0px;
      right: 0px;
      bottom: 0px;
      width:100%"),
    color = ifelse(trendname1 == "D", "black",
      ifelse(trendname1 == "G", "teal",
        "purple"
      )
    ),
    icon = ifelse(trendname1 == "D", "fa-thumbs-down",
      ifelse(trendname1 == "G", "fa-thumbs-up",
        ifelse(trendname1 == "n" & trend$return > 0,
          "fa-thumbs-up",
          "fa-thumbs-down"
        )
      )
    )
  )
})
```

###

```{r 2.1.0.2a-vbox-returns-roi, eval=trend}
trendROIema <- percent(tail(trend[order(endDate)][indicator == 'EMA'],1)[,8][[1]],
  scale = 100, prefix = "", suffix = "%", big.mark = " ", decimal.mark = ".",
  trim = TRUE
)

flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("EMA ROI:", " ", as.character(trendROIema)),
    color = ifelse(trendROIema > 0, "teal",
      ifelse(trendROIema < 0, "danger",
        "grey"
      )
    ),
    icon = ifelse(trendROIema > 0, "fa-smile",
      ifelse(trendROIema < 0, "fa-frown",
        "fa-meh-rolling-eyes"
      )
    )
  )
})
```
```{r 2.1.0.2b-vbox-returns-roi, eval=trend}
trendROI <- percent(tail(trend[order(endDate)][indicator == 'SMA'],1)[,8][[1]],
  scale = 100, prefix = "", suffix = "%", big.mark = " ", decimal.mark = ".",
  trim = TRUE
)

flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("SMA ROI:", " ", as.character(trendROI)),
    color = ifelse(trendROI > 0, "teal",
      ifelse(trendROI < 0, "danger",
        "grey"
      )
    ),
    icon = ifelse(trendROI > 0, "fa-smile",
      ifelse(trendROI < 0, "fa-frown",
        "fa-meh-rolling-eyes"
      )
    )
  )
})
```

###

```{r 2.1.0.3a-vbox-trade-days, eval=trend}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("EMA Trade Days:", " ", format(tail(trend[indicator=='EMA'][order(endDate)], 1)[, 11], big.mark = ",")),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

```{r 2.1.0.3b-vbox-trade-days, eval=trend}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("SMA Trade Days:", " ", format(tail(trend[indicator=='SMA'][order(endDate)], 1)[, 11], big.mark = ",")),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Column {data-height=50%, .tabset .tabset-fade}
-------------------------------------

### Trend Summary Table

```{r 2.1.1.a-table-Trend, eval=trend}
DT::renderDataTable({
  DT::datatable(trend[,-c(9,13:16)],
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr',
      order = list(list(5, "desc"), list(0, 'asc')),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 300,
      scroller = TRUE
    )
  ) %>%
    formatCurrency(
      c("startOpen", "endOpen", "Net.Trading.PL"),
        digits = 2
    ) %>%
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatPercentage("return",2) %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

### Composite Trade Stats
```{r 2.1.1.h-table-tradestats, eval=dt_trade_stats}
# goldenX_EMA_tradestats <- blotter::tradeStats(
#   "goldenX_EMA_portfolio",
#     Dates =
#       paste(format(input$dateRange2.2[1]),format(input$dateRange2.2[2]),sep = "::"))

DT::renderDataTable({
  DT::datatable(dt_trade_stats[,-2],
    rownames = FALSE,
    extensions = c("Scroller"),
#    filter = 'top',
    options = list(
      dom = 'ltipr',
      order = list(list(3, "desc")),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatCurrency(
      c("Net.Trading.PL", "Avg.Trade.PL", "Med.Trade.PL",
        "Largest.Winner", "Largest.Loser",
        "Gross.Profits", "Gross.Losses",
        "Avg.Win.Trade", "Med.Win.Trade", 
        "Avg.Losing.Trade", "Med.Losing.Trade",
        "Avg.Daily.PL", "Med.Daily.PL",
        "Max.Drawdown", "Max.Equity", "Min.Equity", "End.Equity"
       ),
        digits = 0
    ) %>%
    formatPercentage(
      c("Percent.Positive", "Percent.Negative")
    ) %>%
    formatRound(
      c("Std.Dev.Trade.PL",   "Std.Err.Trade.PL", "Profit.Factor",
        "Std.Dev.Daily.PL",   "Std.Err.Daily.PL", "Ann.Sharpe",
        "Profit.To.Max.Draw", "Avg.WinLoss.Ratio", "Med.WinLoss.Ratio"
      ),
        digits = 2
    )
})
```

### EMA Trend Return Distribution
```{r 2.1.1.b-viz-box-returns, eval=trendReturns}
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("D")) %>% select(ends_with("EMA")))
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("G")) %>% select(ends_with("EMA")))
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("N")) %>% select(ends_with("EMA")))
```

### SMA Trend Return Distribution

```{r 2.1.1.c-viz-box-returns, eval=trendReturns}
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("D")) %>% select(ends_with("SMA")))
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("G")) %>% select(ends_with("SMA")))
chart.Boxplot(data.table(trendReturns) %>% select(starts_with("N")) %>% select(ends_with("SMA")))
```

### Composite Returns
```{r 2.1.1.d-viz-box-returns, eval=trend}
renderPlotly({
  p <- plot_ly(type = "box") %>%
    add_boxplot(
      y = d$return,
      jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX Returns"
    ) %>%
    add_boxplot(
      y = g$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldeX Returns"
    ) %>%
    add_boxplot(
      y = n$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "n Returns"
    ) %>%
    layout(title = "Composite Returns - EMA + SMA",
          yaxis = list(
          title = 'Return Percentage ',
          tickformat = "%")
    )
})
```

### Returns by MA Type
```{r 2.1.1.e-viz-box-returns, eval=trend}
gSMA = g[indicator == 'SMA']
nSMA = n[indicator == 'SMA']

renderPlotly({
  p <- plot_ly(type = "box") %>%
    add_boxplot(
#      x = d[indicator == 'EMA'],
      y = dEMA$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX-EMA"
    ) %>%
    add_boxplot(
      d = d[indicator == 'SMA'],
      y = d$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX-SMA"
    ) %>%
    add_boxplot(
      g = g[indicator == 'EMA'],
      y = g$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldenX-EMA"
    ) %>%
    add_boxplot(
      y = gSMA$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldenX-SMA"
    ) %>%
    add_boxplot(
      n = n[indicator == 'EMA'],
      y = n$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "No X-EMA"
    ) %>%
    add_boxplot(
      y = nSMA$return, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "No X-SMA"
    ) %>%
    layout(title = "Returns by Moving Average Type",
      yaxis = list(
      title = 'Return Percentage ',
      tickformat = "%")
    )
})
```

### Composite Trade Days
```{r 2.1.1.f-viz-box-trade-days, eval=trend}

renderPlotly({
  p <- plot_ly(type = "box") %>%
    add_boxplot(
      y = d$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX tradeDays"
    ) %>%
    add_boxplot(
      y = g$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldeX tradeDays"
    ) %>%
    add_boxplot(
      y = n$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "n tradeDays"
    ) %>%
      layout(title = "Composite Trade Days - EMA + SMA",
          yaxis = list(
          title = 'Trade Days')
    )
})
```

### Trade Days by MA Type
```{r 2.1.1.g-viz-box-trade-days, eval=trend}
gSMA = g[indicator == 'SMA']
nSMA = n[indicator == 'SMA']

renderPlotly({
  p <- plot_ly(type = "box") %>%
    add_boxplot(
      y = dEMA$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX-EMA"
    ) %>%
    add_boxplot(
      d = d[indicator == 'SMA'],
      y = dSMA$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "DeathX-SMA"
    ) %>%
    add_boxplot(
      g = g[indicator == 'EMA'],
      y = g$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldenX-EMA"
    ) %>%
    add_boxplot(
      y = gSMA$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "GoldenX-SMA"
    ) %>%
    add_boxplot(
      n = n[indicator == 'EMA'],
      y = n$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "No X-EMA"
    ) %>%
    add_boxplot(
      y = nSMA$tradeDays, jitter = 0.3, pointpos = -1.8, boxpoints = "all",
      marker = list(color = "rgb(7,40,89)"),
      line = list(color = "rgb(7,40,89)"),
      name = "No X-SMA"
    ) %>%
      layout(title = "Trade Days by Moving Average Type",
          yaxis = list(
          title = 'Trade Days')
    )
})
```

Row {data-height=33%}
-------------------------------------
### Composite Trend Return Distribution
```{r  2.1.2.1-viz-vboxplot, eval=trend}

renderPlotly({
  ggplotly(
    ggplot(trend, aes(x = paste0(trend$catName, "-", trend$indicator), y = return))
    + scale_y_continuous(labels = percent)
    + geom_boxplot(fill = "#0c4c8a")
    + theme_gray()
    + theme(axis.title.x=element_blank()
          ,axis.text.x = element_text(
            angle = 0
            , vjust = 0
            , size = 8
            , hjust = 1
            , face = "bold")
          )
  )
})
```

### Trend Returns Annualized
```{r 2.1.2.2-viz-pie, eval=trendReturnsAnnualized}
m <- melt(trendReturnsAnnualized[1,], id.vars = c("rn"))[,-1]
names(m) <- c("trend", "return")
m <- m[-7, `:=`(trend=str_sub(trend, end = -4), indicator= str_sub(trend, -3, -1))]
mEMA <- m[indicator=='EMA']
mSMA <- m[indicator=='SMA']
renderPlotly({
   p <- plot_ly(type = "bar") %>%
     add_bars(mEMA, x = ~mEMA$trend, y = ~mEMA$return, text = ~mEMA$indicator, textposition = 'auto',
               marker = list(color =
                   c('black'
                   ,'teal'
                   ,'purple'))) %>%
     add_bars(mSMA, x = ~mSMA$trend, y = ~mSMA$return, text = ~mSMA$indicator, textposition = 'auto',
               marker = list(color =
                   c('black'
                   ,'teal'
                   ,'purple'
                   ))) %>%
     layout(
       xaxis = list(title = ""),
       yaxis = list(
         title = 'Percent',
         tickformat = "%"),
       barmode = 'group', bargap = 0.15, bargroupgap = 0.1,
       showlegend = FALSE)

})
```

### Trend Trade Days Distribution

```{r 2.1.2.3-viz-barchart, eval=trendSummaryGroup}

# emaPct <- trendSummaryGroup[1:3, occurrencePct := count/sum(count)][1:3, tradeDaysPct := tradeDays/sum(tradeDays)][1:3, c(2:5,8,7)]
# smaPct <- trendSummaryGroup[4:6, occurrencePct := count/sum(count)][4:6, tradeDaysPct := tradeDays/sum(tradeDays)][4:6, c(2:5,8,7)]

renderPlotly({
    p <- plot_ly(type = "bar") %>%
      add_bars( x = emaPct$catName, y = emaPct$tradeDaysPct, text = ~emaPct$indicator, textposition = 'auto',
                marker = list(color =
                  c('rgba(0,0,0,1)'
                    ,'teal'
                    ,'purple'))) %>%
      add_bars( x = smaPct$catName, y = smaPct$tradeDaysPct, text = ~smaPct$indicator, textposition = 'auto',
                marker = list(color =
                  c('rgba(0,0,0,1)'
                    ,'teal'
                    ,'purple'))) %>%

      layout(
          yaxis = list(
          title = 'Percent',
          tickformat = "%"),
        barmode = 'group', bargap = 0.15, bargroupgap = 0.1,
        showlegend = F)

}) 
```

2.2 Golden Cross {data-navmenu="2-Trends" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 2.2.0.1-sidebarInput}

dateRangeInput("dateRange2.2",
  "Golden Crossing Date",
  start = params$dateStart,
  end = Sys.Date()
)
```

```{r 2.2.0.2-sidebarRadio}
radioButtons("radio2.2", "Moving Avg:",
               c("Exponential" = 3,
                 "Simple" = 4)
)
```

Column {data-height=21%}
-------------------------------------

###

```{r 2.2.1.1.a-vbox-goldenx-trend-name}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("Golden Cross", toupper(str_sub(colnames(trendReturnsDaily[,as.numeric(input$radio2.2)]),-3, -1))),
    color = 'teal',
    icon = 'fa-cross'
  )
})
```

```{r 2.2.1.1.b-vbox-goldenx-calendar-days, eval=trend}
flexdashboard::renderValueBox({

  calendarDays <- format(input$dateRange2.2[2] - input$dateRange2.2[1], big.mark = ",")
  calendarDays <- substr(calendarDays, 1, nchar(calendarDays) - 5)

  flexdashboard::valueBox(
    paste(calendarDays, " ", "Calendar Days"),
  )
})
```

###

```{r 2.2.1.2-vbox-goldenx-return-annual}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          Return.annualized(
            na.omit(
              trendReturnsDaily
                [,as.numeric(input$radio2.2)])
                [paste(format(input$dateRange2.2[1]),format(input$dateRange2.2[2]),sep = "::")]
          )
        )
      ), "", " Annual Return"
    ),
    color = ifelse(Return.annualized(
        na.omit(
          trendReturnsDaily
            [,as.numeric(input$radio2.2)])
            [paste(format(input$dateRange2.2[1]),format(input$dateRange2.2[2]),sep = "::")]) > 0, 
           "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.2.1.3-vbox-goldenx-returns-cumulative}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          as.numeric(
            Return.cumulative(
              na.omit(trendReturnsDaily
                [,as.numeric(input$radio2.2)])
                [paste(format(input$dateRange2.2[1][+1]), format(input$dateRange2.2[2]),sep = "::")]
                [-1,]
            )
          )
        )
      ), "", " Cumulative"
    ),
    color = ifelse(Return.cumulative(
        na.omit(
          trendReturnsDaily
            [,as.numeric(input$radio2.2)])
            [paste(format(input$dateRange2.2[1][+1]), format(input$dateRange2.2[2]),sep = "::")]) > 0,
      "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.2.1.4-vbox-goldenx-trade-days}
flexdashboard::renderValueBox({
  tradeDays <-   as.character(ndays(
      na.omit(
        trendReturnsDaily
          [,as.numeric(input$radio2.2)])
          [paste(format(input$dateRange2.2[1]), format(input$dateRange2.2[2]),sep = "::")]
    )
  )

  flexdashboard::valueBox(
    paste("Trade Days: ", "", tradeDays),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Column {data-height=50%, data-width=500 .tabset .tabset-fade}
-------------------------------------

### Price & Transactions Chart
```{r 2.2.2.1-viz-goldenx-posn-chartstats}

  renderPlot({
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.2) - 2),])
    blotter::getPortfolio(paste0("gX", ind), envir = .blotter)
    na.omit(getSymbols("SPL.AX", src = 'FI', dir = ".", split_method = 'common', env = .blotter))
    blotter::chart.Posn(paste0("gX", ind),
      Symbol = "SPL.AX",
      Dates  = paste(format(input$dateRange2.2[1]), format(input$dateRange2.2[2]),sep = "::"),
      env    = .blotter,
      TA     = "add_SMA(n = 20, col = 2); add_SMA(n = 50, col = 4)")
   })

```

### Golden Crossing Table

```{r 2.2.2.2-table-goldenx, eval=trend}

DT::renderDataTable({
    ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.2) - 2),]
    trendTable <- trend[indicator == ind]
    trendTable <- trendTable[catName == "GoldenX" &
                        (startDate >= input$dateRange2.2[1] &
                         endDate <= input$dateRange2.2[2])][,-c(9,13:16)]
    DT::datatable(trendTable,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr',
      order = list(list(5, "desc"), list(0, 'asc')),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatCurrency(c("startOpen", "endOpen")) %>%
    formatCurrency("Net.Trading.PL", digits = 0) %>%
    formatPercentage("return", 1) %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

Column {data-height=33%}
-------------------------------------
### GoldenX Return

```{r 2.2.3.1-viz-goldenx-roi-outliers}
xhpG <- list(title = g$catName, titlefont = F)
yhpG <- list(title = "Counts", titlefont = F)
ybpG <- list(title = g$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.2) - 2),]
  g <- g[indicator == ind]
  g <- g[(startDate >= input$dateRange2.2[1] &
          endDate   <= input$dateRange2.2[2])]

  histogramG <- plot_ly(g, x = g$return, type = "histogram", marker = list(color = "teal")) %>%
    layout(
      xaxis = xhpG
      ,yaxis = yhpG
      )

  boxplotG <- plot_ly(
              g
              ,x = g$return
              ,type = "box"
              ,boxpoints = "all"
              ,jitter = 0.3
              ,marker = list(
                color = "teal"
                ,outliercolor = "blue")
              ) %>%
              layout(
                yaxis = ybpG
              )
  boxplotG$data[[1]]$name <- 'Group A'

  # boxplotG$x$data[[1]]$name <- 'Group A'       https://is.gd/qChas5
  subplot(boxplotG, histogramG, nrows = 2, shareX = TRUE) %>%
    layout(
      xaxis = list(tickformat = "%")
      ,title = "ROI with Outliers"
      ,bargap = 0.1
      ,showlegend = FALSE)
})
```

### GoldenX Trade Days

```{r 2.2.3.2-viz-goldenx-trade-days}
xhpG <- list(title = g$catName, titlefont = F)
yhpG <- list(title = "Counts", titlefont = F)
ybpG <- list(title = g$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.2) - 2),]
  g <- g[indicator == ind]
  g <- g[(startDate >= input$dateRange2.2[1] &
          endDate   <= input$dateRange2.2[2])]

  histogramG <- plot_ly(g, x = g$tradeDays, type = "histogram", marker = list(color = "teal")) %>%
    layout(xaxis = xhpG, yaxis = yhpG)

  boxplotG <- plot_ly(g, x = g$tradeDays, type = "box", boxpoints = "all", jitter = 0.3, marker = list(color = "teal", outliercolor = "blue")) %>%
    layout(yaxis = ybpG)
  subplot(boxplotG, histogramG, nrows = 2, shareX = TRUE) %>%
    layout(showlegend = FALSE) %>%
    layout(title = "# of Trade Days with Outliers", bargap = 0.1)
})
```

2.3 Death Cross {data-navmenu="2-Trends" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 2.3.0.1-sidebarInput}

dateRangeInput("dateRange2.3",
  "DeathX data",
  start = params$dateStart,
  end = Sys.Date()
)
```

```{r 2.3.0.2-sidebarRadio}
radioButtons("radio2.3", "Moving Avg:",
               c("Exponential" = 1,
                 "Simple" = 2)
)
```

Row {data-height=21%}
-------------------------------------

###

```{r 2.3.1.1.a-vbox-trend-name}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste("Death Cross", toupper(str_sub(colnames(trendReturnsDaily[,as.numeric(input$radio2.3)]),-3, -1))),
    color = 'black',
    icon = 'fa-cross'
  )
})
```

```{r 2.3.1.1.b-vbox-deathx-calendar-days, eval=trend}
flexdashboard::renderValueBox({

  calendarDays <- format(input$dateRange2.3[2] - input$dateRange2.3[1], big.mark = ",")
  calendarDays <- substr(calendarDays, 1, nchar(calendarDays) - 5)

  flexdashboard::valueBox(
    paste(calendarDays, " ", "Calendar Days"),
  )
})
```

###

```{r 2.3.1.2-deathx-vbox-returns-annual}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          Return.annualized(
            na.omit(
              trendReturnsDaily[,as.numeric(
                input$radio2.3)])[paste(format(input$dateRange2.3[1]),
                  format(input$dateRange2.3[2]),sep = "::")]
          ) * -1
        )
      ), "", " Annual Return"
    ),
    color = ifelse(Return.annualized(
        na.omit(
          trendReturnsDaily[,as.numeric(
            input$radio2.3)])[paste(format(input$dateRange2.3[1]),
              format(input$dateRange2.3[2]),sep = "::")]) * -1 > 0, 
                "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.3.1.3-vbox-returns-cumulative}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          as.numeric(
            Return.cumulative(
              na.omit(trendReturnsDaily
                [,as.numeric(input$radio2.3)])
                [paste(format(input$dateRange2.3[1][+1]), format(input$dateRange2.3[2]),sep = "::")]
                [-1,]
            ) * -1
          )
        )
      ), "", " Cumulative"
    ),
    color = ifelse(Return.cumulative(
        na.omit(
          trendReturnsDaily
            [,as.numeric(input$radio2.3)])
            [paste(format(input$dateRange2.3[1][+1]), format(input$dateRange2.3[2]),sep = "::")]) * -1 > 0, 
      "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.3.1.4-vbox-trade-days}
flexdashboard::renderValueBox({
  tradeDays <-   as.character(
    ndays(
      na.omit(
        trendReturnsDaily[,as.numeric(
          input$radio2.3)])[paste(format(input$dateRange2.3[1]),
            format(input$dateRange2.3[2]),sep = "::")]
    )
  )
  flexdashboard::valueBox(
    paste("Trade Days: ", "", tradeDays),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Column {data-height=50%, data-width=500 .tabset .tabset-fade}
-------------------------------------

### Price & Transactions Chart
```{r 2.3.2.1-viz-deathX-posn-chartstats}

  renderPlot({
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.3) - 0),])
    blotter::getPortfolio(paste0("dX", ind), envir = .blotter)
    na.omit(getSymbols("SPL.AX", src = 'FI', dir = ".", split_method = 'common', env = .blotter))
    blotter::chart.Posn(paste0("dX", ind),
      Symbol = "SPL.AX",
      Dates  = paste(format(input$dateRange2.3[1]), format(input$dateRange2.3[2]),sep = "::"),
      env    = .blotter,
      TA     = "add_SMA(n = 20, col = 2); add_SMA(n = 50, col = 4)")
   })

```

### DeathX Crossing Table

```{r 2.3.2.2-table-death, eval=trend}
DT::renderDataTable({
    ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.3)),]
    trendTable <- trend[indicator == ind]
    trendTable <- trendTable[catName == "DeathX" & 
                        (startDate >= input$dateRange2.3[1] & 
                         endDate <= input$dateRange2.3[2])][,-c(9,13:16)]
    DT::datatable(trendTable,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr',
      order = list(list(5, "desc"), list(0, 'asc')),
      pageLength = 10,
      scrollX = TRUE,
      scrollY = 280,
      scroller = TRUE
    )
  ) %>%
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatCurrency(c("startOpen", "endOpen")) %>%
    formatCurrency("Net.Trading.PL", digits = 0) %>%
    formatPercentage("return", 1) %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

Row {data-height=33%}
-------------------------------------
### DeathX Return

```{r 2.3.3.1-viz-deathx-roi-outliers}
xhpD <- list(title = d$catName, titlefont = F)
yhpD <- list(title = "Counts", titlefont = F)
ybpD <- list(title = d$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.3)),]
  d   <- d[indicator == ind]
  d   <- d[(startDate >= input$dateRange2.3[1] & endDate <= input$dateRange2.3[2])]

  histogramD <- plot_ly(d, x = d$return, type = "histogram", marker = list(color = "black")) %>%
    layout(xaxis = xhpD, yaxis = yhpD)
  boxplotD <- plot_ly(d, x = d$return, type = "box", boxpoints = "all", jitter = 0.3, marker =
    list(color = "black", outliercolor = "blue")) %>%
    layout(yaxis = ybpD)
  subplot(boxplotD, histogramD, nrows = 2, shareX = TRUE) %>%
    layout(
      xaxis = list(tickformat = "%")
      ,title = "ROI with Outliers"
      ,bargap = 0.1
      ,showlegend = FALSE)
})
```

### DeathX Trade Days

```{r 2.3.3.2-viz-deathx-trade-days}
xhp <- list(title = d$catName, titlefont = F)
yhp <- list(title = "Counts", titlefont = F)
ybp <- list(title = d$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.3)),]
  d <- d[indicator == ind]
  d <- d[(startDate >= input$dateRange2.3[1] &
          endDate   <= input$dateRange2.3[2])]

  histogramD <- plot_ly(d, x = d$tradeDays, type = "histogram", marker = list(color = "Black")) %>%
    layout(xaxis = xhp, yaxis = yhp)

  boxplotD <- plot_ly(d, x = d$tradeDays, type = "box", boxpoints = "all", jitter = 0.3, marker = list(color = "black", outliercolor = "#D0A92C", line = list(outliercolor = "#D0A92C", outlierwidth = 5))) %>%
    layout(yaxis = ybp)
  subplot(boxplotD, histogramD, nrows = 2, shareX = TRUE) %>%
    layout(showlegend = FALSE) %>%
    layout(title = "# of Trade Days with Outliers", bargap = 0.1)
})
```

2.4 No Cross {data-navmenu="2-Trends" data-icon="fa-list" data-orientation=rows}
=====================================

Input {.sidebar}
-------------------------------------

```{r 2.4.0.1-sidebarInput}

dateRangeInput("dateRange2.4",
  "No Cross data",
  start = params$dateStart,
  end = Sys.Date()
)
```

```{r 2.4.0.2-sidebarRadio}
radioButtons("radio2.4", "Moving Avg:",
               c("Exponential" = 5,
                 "Simple" = 6)
)
```

Row {data-height=21%}
-------------------------------------

###

```{r 2.4.1.1.a-vbox-noX-trend-name}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
        paste("No Cross", toupper(str_sub(colnames(trendReturnsDaily[,as.numeric(input$radio2.4)]),-3, -1))),
          color = 'purple',
          icon = 'fa-cross'
  )
})
```

```{r 2.4.1.1.b-vbox-noX-calendar-days}
flexdashboard::renderValueBox({

  calendarDays <- format(input$dateRange2.4[2] - input$dateRange2.4[1], big.mark = ",")
  calendarDays <- substr(calendarDays, 1, nchar(calendarDays) - 5)

  flexdashboard::valueBox(
    paste(calendarDays, " ", "Calendar Days"),
  )
})
```

###

```{r 2.4.1.2-vbox-noX-returns-annual}
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          Return.annualized(
            na.omit(
              trendReturnsDaily[,as.numeric(input$radio2.4)])[paste(format(input$dateRange2.4[1]),
                format(input$dateRange2.4[2]),sep = "::")]
          )
        )
      ), "", " Annual Return"
    ),
    color = ifelse(Return.annualized(
        na.omit(
          trendReturnsDaily[,as.numeric(input$radio2.4)])[paste(format(input$dateRange2.4[1]),
            format(input$dateRange2.4[2]),sep = "::")]) > 0,
              "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.4.1.3-vbox-noX-returns-cumulative}
cumReturn <- percent(as.numeric(Return.cumulative(trend[,9])))
flexdashboard::renderValueBox({
  flexdashboard::valueBox(
    paste(
      as.character(
        percent(
          as.numeric(
            Return.cumulative(
              na.omit(trendReturnsDaily[,as.numeric(input$radio2.4)])[paste(format(input$dateRange2.4[1]),
                format(input$dateRange2.4[2]),sep = "::")]
            )
          )
        )
      ), "", " Cumulative"
    ),
    color = ifelse(
      Return.cumulative(
        na.omit(
          trendReturnsDaily[,as.numeric(input$radio2.4)])[paste(format(input$dateRange2.4[1]),
            format(input$dateRange2.4[2]),sep = "::")]) > 0,
              "teal", "red"),
    icon = "ion-cash"
  )
})
```

###

```{r 2.4.1.4-vbox-noX-trade-days, eval=trend}
flexdashboard::renderValueBox({
  tradeDays <-   as.character(
    ndays(
      na.omit(
        trendReturnsDaily[,as.numeric(input$radio2.4)])[paste(format(input$dateRange2.4[1]),
          format(input$dateRange2.4[2]),sep = "::")]
    )
  )
  flexdashboard::valueBox(
    paste("Trade Days: ", "", tradeDays),
    color = # 0000ff
    , icon = "fa-calendar"
  )
})
```

Column {data-height=50%, data-width=500 .tabset .tabset-fade}
-------------------------------------

### Price & Transactions Chart
```{r 2.4.2.1-viz-nox-posn-chartstats}

  renderPlot({
    ind <- tolower(data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.4) - 4),])
    blotter::getPortfolio(paste0("nX", ind), envir = .blotter)
    na.omit(getSymbols("SPL.AX", src = 'FI', dir = ".", split_method = 'common', env = .blotter))
    blotter::chart.Posn(paste0("nX", ind),
     Symbol = "SPL.AX",
     Dates  = paste(format(input$dateRange2.4[1]), format(input$dateRange2.4[2]),sep = "::"),
     env    = .blotter,
     TA     = "add_SMA(n = 20, col = 2); add_SMA(n = 50, col = 4)")
  })

```

### NoX Crossing Table

```{r 2.4.2.2-table-noX, eval=trend}
DT::renderDataTable({
    ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.4) - 4),]
    trendTable <- trend[indicator == ind]
    trendTable <- trendTable[catName == "NoX" &
                        (startDate >= input$dateRange2.4[1] &
                         endDate <= input$dateRange2.4[2])][,-c(9,13:16)]
    DT::datatable(trendTable,
    rownames = FALSE,
    extensions = c("Scroller"),
    filter = 'top',
    options = list(
      dom = 'ltipr',
      order = list(list(5, "desc"), list(0, 'asc')),
      pageLength = 10,
            scroller = TRUE,
      scrollX = 400,
      scrollY = 280
    )
  ) %>%
    formatDate(c("startDate", "endDate")) %>%
    formatRound("tradeDays", 0) %>%
    formatCurrency(c("startOpen", "endOpen")) %>%
    formatCurrency("Net.Trading.PL", digits = 0) %>%
    formatPercentage("return", 1) %>%
    formatStyle("return",
      background = styleColorBar(range(trend$return), "lightblue")
    ) %>%
    formatStyle("tradeDays",
      color = styleInterval(c(0), c("maroon", "darkgreen"))
    )
})
```

Row {data-height=33%}
-------------------------------------
### No X Return

```{r 2.4.3.1-viz-noX-roi-outliers, eval=trend}
xhp <- list(title = n$catName, titlefont = F)
yhp <- list(title = "Counts", titlefont = F)
ybp <- list(title = n$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.4) - 4),]
  n   <- n[indicator == ind]
  n   <- n[(startDate >= input$dateRange2.4[1] & endDate <= input$dateRange2.4[2])]

  histogram <- plot_ly(n, x = n$return, type = "histogram", marker = list(color = "purple")) %>%
    layout(xaxis = xhp, yaxis = yhp)
  boxplot <- plot_ly(n, x = n$return, type = "box", boxpoints = "all", jitter = 0.3, marker =
    list(color = "purple", outliercolor = "blue")) %>%
    layout(yaxis = ybp)
  subplot(boxplot, histogram, nrows = 2, shareX = TRUE) %>%
    layout(
      xaxis = list(tickformat = "%")
      ,title = "ROI with Outliers"
      ,bargap = 0.1
      ,showlegend = FALSE)
})
```

### No X Trade Days

```{r 2.4.3.2-viz-noX-trade-days}
xhp <- list(title = n$catName, titlefont = F)
yhp <- list(title = "Counts", titlefont = F)
ybp <- list(title = n$catName, titlefont = F)

renderPlotly({
  ind <- data.table::setorder(unique(trend[,1]))[(as.numeric(input$radio2.4) - 4),]
  n <- n[indicator == ind]
  n <- n[(startDate >= input$dateRange2.4[1] & 
          endDate   <= input$dateRange2.4[2])]

  histogramN <- plot_ly(n, x = n$tradeDays, type = "histogram", marker = list(color = "purple")) %>%
    layout(xaxis = xhp, yaxis = yhp)

  boxplotN <- plot_ly(n, x = n$tradeDays, type = "box", boxpoints = "all", jitter = 0.3, marker = list(color = "purple", outliercolor = "#D0A92C", line = list(outliercolor = "#D0A92C", outlierwidth = 5))) %>%
    layout(yaxis = ybp)
  subplot(boxplotN, histogramN, nrows = 2, shareX = TRUE) %>%
    layout(showlegend = FALSE) %>%
    layout(title = "# of Trade Days with Outliers", bargap = 0.1)
})
```
